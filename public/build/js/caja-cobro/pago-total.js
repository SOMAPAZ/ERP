import{getSearch,formatNum,roundAndFloat,formatDateText}from"../helpers/index.js";import GetDatos from"../classes/GetData.js";import PostDatos from"../classes/PostData.js";import Alerta from"../classes/Alerta.js";import Modal from"../classes/Modal.js";(()=>{const e=document.querySelector("#id_user"),t=document.querySelector("#nombre_usuario"),a=document.querySelector("#tipo_usuario"),o=document.querySelector("#mes_inicio"),r=document.querySelector("#mes_fin"),n=document.querySelector("#total"),l=document.querySelector("#total_agua"),d=document.querySelector("#total_drenaje"),c=document.querySelector("#total_recargos"),i=document.querySelector("#total_iva"),s=document.querySelector("#realizar-pago"),u=document.querySelector("#realizar-desc"),m=document.querySelector("#eliminar-desc"),p=document.querySelector("#descuento-inicio-year"),g=document.querySelectorAll('input[name="tipo_pago"]');let f,y=0,v=0,x=0,h=0,_=0,b=[],w=[],S=[];document.addEventListener("DOMContentLoaded",(()=>{f=getSearch(),j(),s.addEventListener("click",k),u.addEventListener("click",N),g.forEach((e=>e.addEventListener("click",(()=>{_=e.value})))),m.addEventListener("click",q),p?.addEventListener("click",C)}));const j=async()=>{const e=f.usuario,t=`${location.origin}/api/usuario?id=${e}`,a=`${location.origin}/deuda-usuario?id=${e}`;[b,w]=await Promise.all([GetDatos.consultar(t),GetDatos.consultar(a)]),E(w)},E=s=>{e.value=b.id,t.value=`${b.user} ${b.lastname}`,a.value=`${b.id_usertype}`,o.value=formatDateText(s.periodo.inicio),r.value=formatDateText(s.periodo.final),n.value=`${formatNum(s.total)} MN`,l.value=`$ ${formatNum(s.agua)}`,d.value=`$ ${formatNum(s.drenaje)}`,c.value=`$ ${formatNum(s.recargos.total)}`,i.value=`$ ${formatNum(s.iva.total)}`},k=()=>{0!==_?Swal.fire({title:`¿Abonar $${formatNum(S.total?S.total:w.total)} MN?`,text:"Esta acción no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Confirmar pago",cancelButtonText:"Cancelar"}).then((e=>e.isConfirmed?async function(){const e=fechaMinMax();document.querySelectorAll("input[type='radio']").forEach((e=>{e.checked&&(deudaGral.tipoPago=e.value)}));const t=new FormData;t.append("id_user",usuario_informacion.id),t.append("mes_incio",e.min.toLocaleDateString("en-US")),t.append("mes_fin",e.max.toLocaleDateString("en-US")),t.append("monto_agua",deudaGral.agua),t.append("monto_drenaje",deudaGral.drenaje),t.append("monto_iva_agua",deudaGral.aguaIVA),t.append("monto_iva_drenaje",deudaGral.drenajeIVA),t.append("monto_recargo_agua",deudaGral.recargoAgua),t.append("monto_recargo_drenaje",deudaGral.recargoDrenaje),t.append("numero_meses",deudaGral.meses),t.append("tipo_pago",deudaGral.tipoPago),t.append("monto_descuento_recargo_agua",RecNaturalAgua?Number(RecNaturalAgua):0),t.append("monto_descuento_recargo_drenaje",RecNaturalDrenaje?Number(RecNaturalDrenaje):0),t.append("total",deudaGral.total);try{const e=`${location.origin}/api/pago-total`,a=await fetch(e,{method:"POST",body:t}),o=await a.json();"Exito"===o.tipo&&(Swal.fire({title:`Pago guardado correctamente con folio ${o.folio}`,text:"El pago se ha guardado correctamente",icon:"success",confirmButtonText:"Mostrar recibo",allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1}).then((e=>{e.isConfirmed&&window.open(`pdf/recibo?folio=${o.folio}&id=${usuario_informacion.id}`,"_blank")})),limpiarHTML(document.querySelector("#radio_inputs")),limpiarHTML(divBoton),consultarInfoUsuario(usuario_informacion.id),fechas=[])}catch(e){console.log(e)}}():"")):Alerta.Toast.fire({icon:"warning",title:"Seleccione un tipo de pago"})};const N=()=>{const e=document.createElement("FORM");e.className="p-4 md:p-5",e.innerHTML='<svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>',e.onsubmit=e=>e.preventDefault();const t=document.createElement("H3");t.className="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400",t.textContent="Ingrese el monto de recargos a descontar";const a=document.createElement("DIV");a.id="div-notif";const o=document.createElement("BUTTON");o.className="text-xs font-semibold rounded-sm text-yellow-900 hover:bg-yellow-900 hover:text-white border border-yellow-900 px-3 py-1 dark:text-yellow-200 dark:border-yellow-200 dark:hover:bg-yellow-200 dark:hover:text-gray-900 mb-2",o.textContent="Porcentaje",o.type="button",o.id="botton-desc-tipo",o.dataset.tipo=1,o.ondblclick=e=>D(e);const r=document.createElement("INPUT");r.className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 mb-4 text-gray-900 placeholder:text-gray-400 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:placeholder:text-gray-500",r.type="number",r.name="descuento";const n=document.createElement("BUTTON");n.className="text-white bg-red-600 hover:bg-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center",n.textContent="Calcular",n.onclick=e=>A(e),e.appendChild(t),e.appendChild(a),e.appendChild(r),e.appendChild(o),e.appendChild(n),Modal.renderModal(e,n)},D=e=>{e.preventDefault();let t=e.target;t.parentElement.querySelector("input").value="","1"===t.dataset.tipo?t.textContent="Pesos":t.textContent="Porcentaje","1"===t.dataset.tipo?t.dataset.tipo=2:t.dataset.tipo=1},A=e=>{e.preventDefault();const t=e.target.parentElement.parentElement,a=t.querySelectorAll("input");PostDatos.crearFormData(a);const o=t.querySelector("input").value;let r=0;const n=document.querySelector(".default-modal #botton-desc-tipo").dataset.tipo;if(S=structuredClone(w),"1"===n){if(o>100)return void Alerta.Toast.fire({icon:"error",title:"Debe ingresar un porcentaje menor al 100%"});r=o}if("2"===n){const e=parseFloat(o);if(e>w.recargos.total)return void Alerta.Toast.fire({icon:"error",title:"Debe ingresar una cantidad menor al total de recargos"});r=100*e/w.recargos.total}v=w.recargos.agua*(r/100),h=w.recargos.drenaje*(r/100),S.recargos.agua=roundAndFloat(w.recargos.agua-v),S.recargos.drenaje=roundAndFloat(w.recargos.drenaje-h),S.recargos.total=roundAndFloat(w.recargos.total-w.recargos.total*(r/100)),S.total=roundAndFloat(S.total-w.recargos.total*(r/100)),console.log(S),E(S),u.classList.add("hidden"),m.classList.remove("hidden"),document.querySelector(".default-modal")?.remove()},C=()=>{if(S=structuredClone(w),w.meses.rezagados>0)return void Alerta.Toast.fire({icon:"error",title:"El usuario debe ir al corriente"});if("Normal"!==b.id_usertype)return void Alerta.Toast.fire({icon:"warning",title:"Este usuario ya cuenta con su respectivo descuento"});y=w.agua-.1*w.agua,x=w.drenaje-.1*w.drenaje,S.agua=roundAndFloat(y),S.drenaje=roundAndFloat(x),S.iva.total=w.iva.total-.1*w.iva.total,S.total=w.total-.1*w.total,E(S),p.classList.add("hidden");const e=document.createElement("BUTTON");e.className="bg-red-200 text-red-800 px-4 py-2 rounded-lg font-black text-xs uppercase hover:bg-red-300",e.textContent="Eliminar descuento",e.onclick=()=>{S=[],E(w),e.remove(),p.classList.remove("hidden")},p.parentElement.appendChild(e)},q=()=>{u.classList.remove("hidden"),m.classList.add("hidden"),S=[],E(w)}})();