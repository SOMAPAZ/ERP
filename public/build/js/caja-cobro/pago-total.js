import{getSearch,formatNum,roundAndFloat,formatDateText,getLocalStorage}from"../helpers/index_v1.js";import GetDatos from"../classes/GetData_v1.js";import PostDatos from"../classes/PostData_v1.js";import Alerta from"../classes/Alerta_v1.js";import Modal from"../classes/Modal_v1.js";(()=>{const e=document.querySelector("#id_user"),t=document.querySelector("#nombre_usuario"),o=document.querySelector("#tipo_usuario"),a=document.querySelector("#mes_inicio"),r=document.querySelector("#mes_fin"),n=document.querySelector("#total"),l=document.querySelector("#total_agua"),c=document.querySelector("#total_drenaje"),d=document.querySelector("#total_recargos"),i=document.querySelector("#total_iva"),s=document.querySelector("#realizar-pago"),u=document.querySelector("#realizar-desc"),m=document.querySelector("#eliminar-desc"),g=document.querySelector("#descuento-inicio-year"),p=document.querySelectorAll('input[name="tipo_pago"]');let f,v=0,y=0,x=0,h=0,b=0,w=[],S=[],$=[],k=[];document.addEventListener("DOMContentLoaded",(()=>{f=getSearch(),E(),s.addEventListener("click",C),u.addEventListener("click",q),p.forEach((e=>e.addEventListener("click",(()=>{b=e.value})))),m.addEventListener("click",j),g?.addEventListener("click",_)}));const E=async()=>{const e=f.usuario,t=`${location.origin}/api/usuario?id=${e}`,o=`${location.origin}/deuda-usuario?id=${e}`;[w,S]=await Promise.all([GetDatos.consultar(t),GetDatos.consultar(o)]),N(S)},N=s=>{e.value=w.id,t.value=`${w.user} ${w.lastname}`,o.value=`${w.id_usertype}`,a.value=formatDateText(s.periodo.inicio),r.value=formatDateText(s.periodo.final),n.value=`${formatNum(s.total)} MN`,l.value=`$ ${formatNum(s.agua)}`,c.value=`$ ${formatNum(s.drenaje)}`,d.value=`$ ${formatNum(s.recargos.total)}`,i.value=`$ ${formatNum(s.iva.total)}`},C=()=>{if(!b)return void Alerta.Toast.fire({icon:"warning",title:"Seleccione un tipo de pago"});$=getLocalStorage("costosAdicionales")?getLocalStorage("costosAdicionales"):[];const e=$.length>0?$.reduce(((e,t)=>e+(+t.cantidad+ +t.cantidad_iva)),0):0;S.nota=document.querySelector("#notas").value,Swal.fire({title:`Pago de $${formatNum(k.total?k.total+e:S.total+e)} MN`,text:`Â¿Abonar $${formatNum(k.total?k.total:S.total)} MN por servicio${e?` y $${formatNum(e)} MN adicionales`:""}?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Confirmar pago",cancelButtonText:"Cancelar"}).then((e=>e.isConfirmed?D():Swal.fire("Pago no aplicado","","warning")))},D=async()=>{const e=[{id_user:f.usuario},{resDebt:S},{descuentoAgua:v},{descuentoRecargoAgua:y},{descuentoDren:x},{descuentoRecargoDren:h},{tipoPago:b},{adicionales:$},{seleccionado:[]}],t=new FormData;t.append("montos",JSON.stringify(e));try{const e=`${location.origin}/api/pago-total`,o=await fetch(e,{method:"POST",body:t}),a=await o.json();"Exito"===a.tipo&&Swal.fire({title:`Pago guardado correctamente con folio ${a.folio}`,text:"El pago se ha guardado correctamente",icon:"success",confirmButtonText:"Mostrar recibo",allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1}).then((e=>{e.isConfirmed&&(window.open(`pdf/recibo?folio=${a.folio}&id=${f.usuario}`,"_blank"),location.reload())}))}catch(e){console.log(e)}},q=()=>{const e=document.createElement("FORM");e.className="p-4 md:p-5",e.innerHTML='<svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>',e.onsubmit=e=>e.preventDefault();const t=document.createElement("H3");t.className="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400",t.textContent="Ingrese el monto de recargos a descontar";const o=document.createElement("DIV");o.id="div-notif";const a=document.createElement("BUTTON");a.className="text-xs font-semibold rounded-sm text-yellow-900 hover:bg-yellow-900 hover:text-white border border-yellow-900 px-3 py-1 dark:text-yellow-200 dark:border-yellow-200 dark:hover:bg-yellow-200 dark:hover:text-gray-900 mb-2",a.textContent="Porcentaje",a.type="button",a.id="botton-desc-tipo",a.dataset.tipo=1,a.ondblclick=e=>A(e);const r=document.createElement("INPUT");r.className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 mb-4 text-gray-900 placeholder:text-gray-400 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:placeholder:text-gray-500",r.type="number",r.name="descuento";const n=document.createElement("BUTTON");n.className="text-white bg-red-600 hover:bg-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center",n.textContent="Calcular",n.onclick=e=>T(e),e.appendChild(t),e.appendChild(o),e.appendChild(r),e.appendChild(a),e.appendChild(n),Modal.renderModal(e,n)},A=e=>{e.preventDefault();let t=e.target;t.parentElement.querySelector("input").value="","1"===t.dataset.tipo?t.textContent="Pesos":t.textContent="Porcentaje","1"===t.dataset.tipo?t.dataset.tipo=2:t.dataset.tipo=1},T=e=>{e.preventDefault();const t=e.target.parentElement.parentElement,o=t.querySelectorAll("input");if(!PostDatos.crearFormData(o))return;const a=t.querySelector("input").value;let r=0;const n=document.querySelector(".default-modal #botton-desc-tipo").dataset.tipo;if(k=structuredClone(S),"1"===n){if(a>100)return void Alerta.Toast.fire({icon:"error",title:"Debe ingresar un porcentaje menor al 100%"});r=a}if("2"===n){const e=parseFloat(a);if(e>S.recargos.total)return void Alerta.Toast.fire({icon:"error",title:"Debe ingresar una cantidad menor al total de recargos"});r=100*e/S.recargos.total}y=S.recargos.agua*(r/100),h=S.recargos.drenaje*(r/100),k.recargos.agua=roundAndFloat(S.recargos.agua-y),k.recargos.drenaje=roundAndFloat(S.recargos.drenaje-h),k.recargos.total=roundAndFloat(S.recargos.total-S.recargos.total*(r/100)),k.total=roundAndFloat(k.total-S.recargos.total*(r/100)),N(k),u.classList.add("hidden"),m.classList.remove("hidden"),document.querySelector(".default-modal")?.remove()},_=()=>{if(k=structuredClone(S),S.meses.rezagados>0)return void Alerta.Toast.fire({icon:"error",title:"El usuario debe ir al corriente"});if("Normal"!==w.id_usertype)return void Alerta.Toast.fire({icon:"warning",title:"Este usuario ya cuenta con su respectivo descuento"});v=S.agua-.1*S.agua,x=S.drenaje-.1*S.drenaje,k.agua=roundAndFloat(v),k.drenaje=roundAndFloat(x),k.iva.total=S.iva.total-.1*S.iva.total,k.total=S.total-.1*S.total,N(k),g.classList.add("hidden");const e=document.createElement("BUTTON");e.className="bg-red-200 text-red-800 px-4 py-2 rounded-lg font-black text-xs uppercase hover:bg-red-300",e.textContent="Eliminar descuento",e.onclick=()=>{k=[],N(S),e.remove(),g.classList.remove("hidden")},g.parentElement.appendChild(e)},j=()=>{u.classList.remove("hidden"),m.classList.add("hidden"),k=[],N(S)}})();