import{getSearch,formatNum,roundAndFloat,formatDateText,getLocalStorage}from"../helpers/index_v1.js";import GetDatos from"../classes/GetData_v1.js";import PostDatos from"../classes/PostData_v1.js";import Alerta from"../classes/Alerta_v1.js";import Modal from"../classes/Modal_v1.js";(()=>{const e=document.querySelector("#id_user"),t=document.querySelector("#nombre_usuario"),o=document.querySelector("#tipo_usuario"),a=document.querySelector("#mes_inicio"),r=document.querySelector("#mes_fin"),n=document.querySelector("#total"),l=document.querySelector("#total_agua"),d=document.querySelector("#total_drenaje"),c=document.querySelector("#total_recargos"),i=document.querySelector("#total_iva"),s=document.querySelector("#realizar-pago"),u=document.querySelector("#realizar-desc"),m=document.querySelector("#eliminar-desc"),g=document.querySelector("#descuento-inicio-year"),p=document.querySelectorAll('input[name="tipo_pago"]');let v,y=0,f=0,x=0,h=0,b=0,S=[],w=[],N=[],$=[];document.addEventListener("DOMContentLoaded",(()=>{v=getSearch(),k(),s.addEventListener("click",A),u.addEventListener("click",C),p.forEach((e=>e.addEventListener("click",(()=>{b=e.value})))),m.addEventListener("click",j),g?.addEventListener("click",T)}));const k=async()=>{const e=v.usuario,t=`${location.origin}/api/usuario?id=${e}`,o=`${location.origin}/deuda-usuario?id=${e}`;[S,w]=await Promise.all([GetDatos.consultar(t),GetDatos.consultar(o)]),D(w)},D=s=>{e.value=S.id,t.value=`${S.user} ${S.lastname}`,o.value=`${S.id_usertype}`,a.value=formatDateText(s.periodo.inicio),r.value=formatDateText(s.periodo.final),n.value=`${formatNum(s.total)} MN`,l.value=`$ ${formatNum(s.agua)}`,d.value=`$ ${formatNum(s.drenaje)}`,c.value=`$ ${formatNum(s.recargos.total)}`,i.value=`$ ${formatNum(s.iva.total)}`},A=()=>{if(!b)return void Alerta.Toast.fire({icon:"warning",title:"Seleccione un tipo de pago"});N=getLocalStorage("costosAdicionales")?getLocalStorage("costosAdicionales"):[];const e=N.length>0?N.reduce(((e,t)=>e+ +t.cantidad),0):0;Swal.fire({title:`Pago de $${formatNum($.total?$.total+e:w.total+e)} MN`,text:`Â¿Abonar $${formatNum($.total?$.total:w.total)} MN por servicio${e?` y $${formatNum(e)} MN adicionales`:""}?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Confirmar pago",cancelButtonText:"Cancelar"}).then((e=>e.isConfirmed?async function(){const e=[{id_user:v.usuario},{resDebt:w},{descuentoAgua:y},{descuentoRecargoAgua:f},{descuentoDren:x},{descuentoRecargoDren:h},{tipoPago:b},{adicionales:N}],t=new FormData;t.append("montos",JSON.stringify(e));try{const e=`${location.origin}/api/pago-total`,o=await fetch(e,{method:"POST",body:t}),a=await o.json();return void console.log(a)}catch(e){console.log(e)}}():Swal.fire("Pago no aplicado","","warning")))};const C=()=>{const e=document.createElement("FORM");e.className="p-4 md:p-5",e.innerHTML='<svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>',e.onsubmit=e=>e.preventDefault();const t=document.createElement("H3");t.className="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400",t.textContent="Ingrese el monto de recargos a descontar";const o=document.createElement("DIV");o.id="div-notif";const a=document.createElement("BUTTON");a.className="text-xs font-semibold rounded-sm text-yellow-900 hover:bg-yellow-900 hover:text-white border border-yellow-900 px-3 py-1 dark:text-yellow-200 dark:border-yellow-200 dark:hover:bg-yellow-200 dark:hover:text-gray-900 mb-2",a.textContent="Porcentaje",a.type="button",a.id="botton-desc-tipo",a.dataset.tipo=1,a.ondblclick=e=>E(e);const r=document.createElement("INPUT");r.className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 mb-4 text-gray-900 placeholder:text-gray-400 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:placeholder:text-gray-500",r.type="number",r.name="descuento";const n=document.createElement("BUTTON");n.className="text-white bg-red-600 hover:bg-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center",n.textContent="Calcular",n.onclick=e=>q(e),e.appendChild(t),e.appendChild(o),e.appendChild(r),e.appendChild(a),e.appendChild(n),Modal.renderModal(e,n)},E=e=>{e.preventDefault();let t=e.target;t.parentElement.querySelector("input").value="","1"===t.dataset.tipo?t.textContent="Pesos":t.textContent="Porcentaje","1"===t.dataset.tipo?t.dataset.tipo=2:t.dataset.tipo=1},q=e=>{e.preventDefault();const t=e.target.parentElement.parentElement,o=t.querySelectorAll("input");PostDatos.crearFormData(o);const a=t.querySelector("input").value;let r=0;const n=document.querySelector(".default-modal #botton-desc-tipo").dataset.tipo;if($=structuredClone(w),"1"===n){if(a>100)return void Alerta.Toast.fire({icon:"error",title:"Debe ingresar un porcentaje menor al 100%"});r=a}if("2"===n){const e=parseFloat(a);if(e>w.recargos.total)return void Alerta.Toast.fire({icon:"error",title:"Debe ingresar una cantidad menor al total de recargos"});r=100*e/w.recargos.total}f=w.recargos.agua*(r/100),h=w.recargos.drenaje*(r/100),$.recargos.agua=roundAndFloat(w.recargos.agua-f),$.recargos.drenaje=roundAndFloat(w.recargos.drenaje-h),$.recargos.total=roundAndFloat(w.recargos.total-w.recargos.total*(r/100)),$.total=roundAndFloat($.total-w.recargos.total*(r/100)),D($),u.classList.add("hidden"),m.classList.remove("hidden"),document.querySelector(".default-modal")?.remove()},T=()=>{if($=structuredClone(w),w.meses.rezagados>0)return void Alerta.Toast.fire({icon:"error",title:"El usuario debe ir al corriente"});if("Normal"!==S.id_usertype)return void Alerta.Toast.fire({icon:"warning",title:"Este usuario ya cuenta con su respectivo descuento"});y=w.agua-.1*w.agua,x=w.drenaje-.1*w.drenaje,$.agua=roundAndFloat(y),$.drenaje=roundAndFloat(x),$.iva.total=w.iva.total-.1*w.iva.total,$.total=w.total-.1*w.total,D($),g.classList.add("hidden");const e=document.createElement("BUTTON");e.className="bg-red-200 text-red-800 px-4 py-2 rounded-lg font-black text-xs uppercase hover:bg-red-300",e.textContent="Eliminar descuento",e.onclick=()=>{$=[],D(w),e.remove(),g.classList.remove("hidden")},g.parentElement.appendChild(e)},j=()=>{u.classList.remove("hidden"),m.classList.add("hidden"),$=[],D(w)}})();