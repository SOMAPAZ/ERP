(()=>{const e=document.querySelector("#adeudo-desglose tbody"),t=document.querySelector("#btn-pago-parcial"),n=document.querySelector("#btn-condonar-parcial"),a=(document.querySelector("#btn-condonar-recargos"),document.querySelector("#periodo-label"));let o=[],r={},c=[],d=[],l=0,i={};const s=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:e=>{e.onmouseenter=Swal.stopTimer,e.onmouseleave=Swal.resumeTimer}});async function m(){const t=new FormData;t.append("id_user",x());try{const n=`${location.origin}/api/deuda-mostrar`,o=await fetch(n,{method:"POST",body:t}),r=await o.json();c=r.deuda_usuario,d=r.data_usuario;const i=[...c].reduce(((e,t)=>e+Number("1"===t.if_recargo?t.if_recargo:0)),0);l=i,function(){g(a),g(e);const t=new Date(`${c[0].year}-${c[0].mes}-07`),n=new Date(`${c[c.length-1].year}-${c[c.length-1].mes}-07`),o=t.toLocaleDateString("es-MX",{year:"numeric",month:"long"}),r=n.toLocaleDateString("es-MX",{year:"numeric",month:"long"}),i=document.createElement("DIV");i.className="flex items-end justify-between rounded-lg border border-gray-200 bg-white p-2 dark:border-gray-800 dark:bg-gray-900 shadow-sm mb-6";const s=document.createElement("P");s.className="text-sm text-gray-500 dark:text-gray-400 mx-auto",s.innerHTML=`Periodo Adeudado: <span class='text-gray-700 uppercase font-bold dark:text-white'>(${o} - ${r})</span>`,i.appendChild(s),a.appendChild(i),function(){const t=document.createElement("TR");t.className="whitespace-nowrap bg-gray-100 border-b dark:bg-gray-700 dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600";const n=document.createElement("TD");n.className="w-4 p-4",n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>';const a=document.createElement("TH");a.scope="row",a.className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white",a.textContent="Todos";const o=document.createElement("TD");o.className="px-6 py-4",o.textContent="Todos";const r=[...c].reduce(((e,t)=>e+Number(t.monto_agua)),0),l=document.createElement("TD");l.className="px-6 py-4",l.textContent=r.toFixed(2);let i=0;parseInt(d.drenaje)&&(i=[...c].reduce(((e,t)=>e+.25*Number(t.monto_agua)),0));const s=document.createElement("TD");s.className="px-6 py-4",s.textContent=i.toFixed(4);let m=0,p=0;const u=[...c].reduce(((e,t)=>e+Number(t.if_recargo)),0);for(let e=0;e<u;e++)m+=Number(.0113*c[e].monto_agua*(e+1)),parseInt(d.drenaje)&&(p+=Number(.25*c[e].monto_agua*.0113*(e+1)));const g=document.createElement("TD");g.className="px-6 py-4",g.textContent=m.toFixed(4);const h=document.createElement("TD");h.className="px-6 py-4",h.textContent=p.toFixed(4);const x=2!==parseInt(d.id_tipo_toma);let y=0;x&&(y=.16*r);const C=.16*i,w=document.createElement("TD");w.className="px-6 py-4",w.textContent=y.toFixed(4);const f=document.createElement("TD");f.className="px-6 py-4",f.textContent=C.toFixed(4);const b=document.createElement("TD");b.className="px-6 py-4",b.textContent=(r+i+y+C+m+p).toFixed(2);const T=document.createElement("TD");T.className="flex items-center px-6 py-4";const D=document.createElement("BUTTON");D.className="font-bold text-gray-500 dark:text-gray-400",D.textContent="Sin acción",T.appendChild(D),t.appendChild(n),t.appendChild(a),t.appendChild(o),t.appendChild(l),t.appendChild(g),t.appendChild(w),t.appendChild(s),t.appendChild(h),t.appendChild(f),t.appendChild(b),t.appendChild(T),e.appendChild(t)}(),c.map((t=>{const n=document.createElement("TR");n.className="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600";const a=document.createElement("TD");a.className="w-4 py-1 px-4";const o=document.createElement("INPUT");o.type="checkbox",o.className="w-6 h-6 text-blue-600 bg-gray-100 border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 cursor-pointer",a.appendChild(o);const r=document.createElement("TH");r.scope="row",r.className="px-4 py-1 font-medium text-gray-900 whitespace-nowrap dark:text-white",r.textContent=t.year;const c=document.createElement("TD");c.className="px-4 py-1",c.textContent=t.mes;const i=document.createElement("TD");i.className="px-4 py-1",i.textContent=t.monto_agua;const s="1"===d.drenaje?.25*t.monto_agua:0,m=document.createElement("TD");m.className="px-4 py-1",m.textContent=s.toFixed(4);const g=.0113*t.monto_agua*l,h=document.createElement("TD");h.className="px-4 py-1";const x=g<=0?0:g;h.textContent=x.toFixed(4);const y=.0113*s*l,C=document.createElement("TD");C.className="px-4 py-1";const w=y<=0?0:y;C.textContent=w.toFixed(4),l--;const f=2===parseInt(d.id_tipo_toma)?0:.16*t.monto_agua,b=document.createElement("TD");b.className="px-4 py-1",b.textContent=f;const T=parseInt(d.drenaje)?.16*s:0,D=document.createElement("TD");D.className="px-4 py-1",D.textContent=T.toFixed(4);const E=document.createElement("TD");E.className="px-4 py-1",E.textContent=(parseFloat(t.monto_agua)+parseFloat(s)+parseFloat(x)+parseFloat(w)+parseFloat(f)+parseFloat(T)).toFixed(2);const k=document.createElement("TD");k.className="flex px-4 py-1 items-center";const N=document.createElement("BUTTON");N.className="font-medium text-blue-600 dark:text-blue-500 hover:underline",N.textContent="Pagar",N.onclick=p;const v=document.createElement("BUTTON");v.className="font-medium text-red-600 dark:text-red-500 hover:underline ms-3",v.textContent="Condonar",v.onclick=u,k.appendChild(N),k.appendChild(v),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(i),n.appendChild(h),n.appendChild(b),n.appendChild(m),n.appendChild(C),n.appendChild(D),n.appendChild(E),n.appendChild(k),e.appendChild(n)}))}()}catch(e){console.log(e)}}function p(e){const t=e.target.parentElement.parentElement,n=t.querySelector("th").textContent,a=t.querySelector("td:nth-child(3)").textContent,o=t.querySelector("td:nth-child(4)").textContent,r=t.querySelector("td:nth-child(5)").textContent,c=t.querySelector("td:nth-child(6)").textContent,l=t.querySelector("td:nth-child(7)").textContent,s=t.querySelector("td:nth-child(8)").textContent,m=t.querySelector("td:nth-child(9)").textContent,p=t.querySelector("td:nth-child(10)").textContent;i={celdaYear:n,celdaMes:a,celdaAgua:o,celdaAguaRec:r,celdaAguaIVA:c,celdaDrenaje:l,celdaDrenajeRec:s,celdaDrenajeIVA:m,celdaTotal:p},Swal.fire({title:`¿Realizar pago por ${i.celdaTotal} mxn?`,text:"Esta acción no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Confirmar pago",cancelButtonText:"Cancelar"}).then((e=>{e.isConfirmed&&async function(){const e=new FormData;e.append("id_user",x()),e.append("mes_inicio",`${i.celdaYear}-${i.celdaMes}-07`),e.append("mes_fin",`${i.celdaYear}-${i.celdaMes}-07`),e.append("monto_agua",i.celdaAgua),e.append("monto_drenaje",i.celdaDrenaje),e.append("monto_iva_agua",i.celdaAguaIVA),e.append("monto_iva_drenaje",i.celdaDrenajeIVA),e.append("monto_recargo_agua",i.celdaAguaRec),e.append("monto_recargo_drenaje",i.celdaDrenajeRec),e.append("recargos",i.celdaDrenajeRec),e.append("numero_meses",1),e.append("tipo_pago",document.querySelector('input[name="tipo_pago"]:checked').value),e.append("total",i.celdaTotal);try{const t=`${location.origin}/api/pago-unico`,n=await fetch(t,{method:"POST",body:e}),a=await n.json();"Exito"===a.tipo&&(Swal.fire({title:`Pago guardado correctamente con folio ${a.folio}`,text:"El pago se ha guardado correctamente",icon:"success",confirmButtonText:"Mostrar recibo",allowOutsideClick:!1,allowEscapeKey:!1}).then((e=>{e.isConfirmed&&window.open(`pdf/recibo?folio=${a.folio}&id=${d.id}`,"_blank")})),y())}catch(e){console.log(e)}}()}))}function u(e){const t=e.target.parentElement.parentElement,n=t.querySelector("th").textContent,a=t.querySelector("td:nth-child(3)").textContent,o=t.querySelector("td:nth-child(10)").textContent,r={};r.year=n,r.mes=a,r.montoTotal=o,Swal.fire({title:`¿Realizar condonación por ${o} mxn?`,text:"Esta acción si se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Confirmar pago",cancelButtonText:"Cancelar"}).then((e=>{e.isConfirmed&&async function(e){const t=new FormData;t.append("id_user",x()),t.append("mes",e.mes),t.append("year",e.year);try{const e=`${location.origin}/api/condonacion-unico`,n=await fetch(e,{method:"POST",body:t}),a=await n.json();console.log(a),"Exito"===a.tipo&&(s.fire({icon:"success",title:a.mensaje}),y())}catch(e){console.log(e)}}(r)}))}function g(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function h(t){const n=e.querySelectorAll("input[type='checkbox']:checked");0!==n.length?(n.forEach((e=>{const t={},n=e.parentElement.parentElement,a=n.querySelector("th").textContent,r=n.querySelector("td:nth-child(3)").textContent,c=n.querySelector("td:nth-child(4)").textContent,d=n.querySelector("td:nth-child(5)").textContent,l=n.querySelector("td:nth-child(6)").textContent,i=n.querySelector("td:nth-child(7)").textContent,s=n.querySelector("td:nth-child(8)").textContent,m=n.querySelector("td:nth-child(9)").textContent,p=n.querySelector("td:nth-child(10)").textContent;t.year=a,t.mes=r,t.montoAgua=c,t.recargoAgua=d,t.ivaAgua=l,t.montoDrenaje=i,t.recargoDrenaje=s,t.ivaDrenaje=m,t.montoTotal=p;const u=o.some((e=>e.year===t.year&&e.mes===t.mes));o=u?[...o]:[...o,t]})),function(e){const t=o.reduce(((e,t)=>e+Number(t.montoTotal)),0);Swal.fire({title:`Confirmar ${"pagar"===e?"pago":"condonación"} parcial`,html:`<p>¿Está seguro de ${"pagar"===e?"pagar":"condonar"} los siguientes meses?</p>\n            <ul style="padding:1rem">\n                ${o.map((e=>`<li style="text-transform: uppercase; text-align:left;">${function(e,t){const n=new Date;n.setFullYear(e),n.setMonth(t-1);return n.toLocaleDateString("es-ES",{year:"numeric",month:"long"})}(e.year,e.mes)}: $ ${e.montoTotal} MNX</li>`)).join("")}\n            </ul>\n            <p style="font-weight:700; font-size:1.5rem">Total a ${"pagar"===e?"pagar":"condonar"}: $ ${t.toFixed(2)} MNX</p>`,icon:"warning",showCancelButton:!0,showDenyButton:"pagar"===e,confirmButtonText:"Confirmar",denyButtonText:"Desc Rec",cancelButtonText:"Cancelar",reverseButtons:!0}).then((t=>{t.isConfirmed?"pagar"===e?async function(){!function(){const e=o.reduce(((e,t)=>e+Number(t.montoAgua)),0),t=o.reduce(((e,t)=>e+Number(t.montoDrenaje)),0),n=o.reduce(((e,t)=>e+Number(t.recargoAgua)),0),a=o.reduce(((e,t)=>e+Number(t.recargoDrenaje)),0),c=o.reduce(((e,t)=>e+Number(t.ivaAgua)),0),d=o.reduce(((e,t)=>e+Number(t.ivaDrenaje)),0),l=e+t+n+a+c+d,i=new Date(o[0].year,o[0].mes-1,7),s=new Date(o[o.length-1].year,o[o.length-1].mes-1,7),m=i.toLocaleDateString("es-ES",{year:"numeric",month:"numeric",day:"numeric"}),p=s.toLocaleDateString("es-ES",{year:"numeric",month:"numeric",day:"numeric"}),u=o.length,g=document.querySelector('input[name="tipo_pago"]:checked').value;r={totalAgua:e,totalDrenaje:t,totalRecAgua:n,totalRecDrenaje:a,totalIvaAgua:c,totalIvaDrenaje:d,total:l,fechaI:m,fechaF:p,meses:u,tipoPago:g}}();const e=new FormData;e.append("id_user",x()),e.append("mes_inicio",r.fechaI),e.append("mes_fin",r.fechaF),e.append("monto_agua",r.totalAgua.toFixed(2)),e.append("monto_drenaje",r.totalDrenaje.toFixed(2)),e.append("monto_iva_agua",r.totalIvaAgua.toFixed(2)),e.append("monto_iva_drenaje",r.totalIvaDrenaje.toFixed(2)),e.append("monto_recargo_agua",r.totalRecAgua.toFixed(2)),e.append("monto_recargo_drenaje",r.totalRecDrenaje.toFixed(2)),e.append("numero_meses",r.meses),e.append("tipo_pago",r.tipoPago),e.append("total",r.total.toFixed(2));try{const t=`${location.origin}/api/pago-parcial`,n=await fetch(t,{method:"POST",body:e}),a=await n.json();console.log(a),"Exito"===a.tipo&&(Swal.fire({title:`Pago guardado correctamente con folio ${a.folio}`,text:"El pago se ha guardado correctamente",icon:"success",confirmButtonText:"Mostrar recibo",allowOutsideClick:!1,allowEscapeKey:!1}).then((e=>{e.isConfirmed&&window.open(`pdf/recibo?folio=${a.folio}&id=${d.id}`,"_blank")})),y())}catch(e){console.log(e)}}():async function(){const e=new Date(o[0].year,o[0].mes-1,7),t=new Date(o[o.length-1].year,o[o.length-1].mes-1,7),n=e.toLocaleDateString("es-ES",{year:"numeric",month:"numeric",day:"numeric"}),a=t.toLocaleDateString("es-ES",{year:"numeric",month:"numeric",day:"numeric"}),r=new FormData;r.append("id_user",x()),r.append("mes_inicio",n),r.append("mes_fin",a);try{const e=`${location.origin}/api/condonacion-parcial`,t=await fetch(e,{method:"POST",body:r}),n=await t.json();"Exito"===n.tipo&&(s.fire({icon:"success",title:n.mensaje}),y())}catch(e){console.log(e)}}():t.isDenied&&function(){const e=document.createElement("DIV");e.className="overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%)] max-h-full bg-gray-500 bg-opacity-75 dark:bg-gray-800 dark:bg-opacity-80";const t=document.createElement("DIV");t.className="relative p-4 w-full max-w-md max-h-full mx-auto mt-20";const n=document.createElement("DIV");n.className="relative bg-white rounded-lg shadow dark:bg-gray-700";const a=document.createElement("BUTTON");a.className="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white",a.innerHTML='<svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg><span class="sr-only">Close modal</span>',a.onclick=()=>document.body?.removeChild(e);const o=document.createElement("DIV");o.className="p-4 md:p-5 text-center",o.id="divInputContainer",o.innerHTML='<svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>';const r=document.createElement("H3");r.className="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400",r.textContent="Ingrese el monto de recargos a descontar";const c=document.createElement("BUTTON");c.className="text-xs font-semibold rounded-full text-yellow-900 hover:bg-yellow-900 hover:text-white border border-yellow-900 px-3 py-1 dark:text-yellow-200 dark:border-yellow-200 dark:hover:bg-yellow-200 dark:hover:text-gray-900 mb-2",c.textContent="Porcentaje",c.id="btnChange";const d=document.createElement("INPUT");d.className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 mb-4 text-gray-900 placeholder:text-gray-400 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:placeholder:text-gray-500",d.type="number";const l=document.createElement("BUTTON");l.className="text-white bg-red-600 hover:bg-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center",l.textContent="Calcular";const i=document.createElement("BUTTON");i.className="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700",i.textContent="Cancelar",i.onclick=()=>document.body?.removeChild(e),o.appendChild(r),o.appendChild(c),o.appendChild(d),o.appendChild(l),o.appendChild(i),n.appendChild(a),n.appendChild(o),t.appendChild(n),e.appendChild(t),document.body.appendChild(e)}()}))}(t)):Swal.fire({title:"Error",text:"Debe seleccionar al menos un registro",icon:"error"})}function x(){const e=new URLSearchParams(window.location.search);return Object.fromEntries(e.entries()).usuario}function y(){o=[],r={},c=[],d=[],l=0,i={},m()}document.addEventListener("DOMContentLoaded",(()=>{m(),t.addEventListener("click",(()=>{h("pagar")})),n.addEventListener("click",(()=>{h("condonar")}))}))})();