import{formatDateText,getSearch,limpiarHTML,formatNum,formatDateMY}from"../helpers/index_v1.js";import GetDatos from"../classes/GetData_v1.js";import Alerta from"../classes/Alerta_v1.js";import PostDatos from"../classes/PostData_v1.js";(()=>{const e=document.querySelector("#adeudo-desglose tbody"),t=document.querySelector("#btn-pago-parcial"),a=document.querySelector("#btn-condonar-parcial"),o=(document.querySelector("#btn-condonar-recargos"),document.querySelector("#periodo-label"));let n={},d=[],r=[],c=[],i=[],s=[],l=[],p=[];document.addEventListener("DOMContentLoaded",(()=>{m(),t.addEventListener("click",(()=>{x()})),a.addEventListener("click",(()=>{x(!0)}))}));const m=async()=>{const e=getSearch().usuario,t=`${location.origin}/api/usuario?id=${e}`,a=`${location.origin}/deuda-usuario?id=${e}`,o=`${location.origin}/deuda-desglosada?id=${e}`;[r,i,c]=await Promise.all([GetDatos.consultar(t),GetDatos.consultar(a),GetDatos.consultar(o)]),u()},u=()=>{limpiarHTML(o),limpiarHTML(e);const t=document.createElement("P");t.className="text-center my-5 py-5 text-sm uppercase font-bold border border-dashed border-gray-300 rounded dark:bg-gray-700 dark:text-gray-300",t.textContent=`Periodo: ${formatDateText(i.periodo.inicio)} a ${formatDateText(i.periodo.final)}`,o.appendChild(t),c.map((t=>{const a=document.createElement("TR");a.className="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600",a.dataset.idx=t.idxDB;const o=document.createElement("TD");o.className="w-4 py-1 px-4";const n=document.createElement("INPUT");n.type="checkbox",n.className="w-6 h-6 text-blue-600 bg-gray-100 border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 cursor-pointer disabled:cursor-not-allowed",t.medido.lectura_actual>0&&"Medido"===r.id_servicetype||"Fijo"===r.id_servicetype?n.disabled=!1:n.disabled=!0,o.appendChild(n);const d=document.createElement("TH");d.scope="row",d.className="px-4 py-1 font-medium text-gray-900 whitespace-nowrap dark:text-white",d.textContent=t.year;const c=document.createElement("TD");c.className="px-4 py-1",c.textContent=t.mes;const i=document.createElement("TD");i.className="px-4 py-1",i.textContent=t.tarifa;const s=document.createElement("TD");s.className="px-4 py-1",s.textContent=t.tarifa-t.agua;const l=document.createElement("TD");l.className="px-4 py-1",l.textContent=t.agua;const p=document.createElement("TD");p.className="px-4 py-1",p.textContent=t.drenaje;const m=document.createElement("TD");m.className="px-4 py-1",m.textContent=t.rec_agua;const u=document.createElement("TD");u.className="px-4 py-1",u.textContent=t.rec_drain;const x=document.createElement("TD");x.className="px-4 py-1",x.textContent=t.iva_agua;const g=document.createElement("TD");g.className="px-4 py-1",g.textContent=t.iva_drenaje;const y=document.createElement("TD");if(y.className="px-4 py-1",y.textContent=t.total.general,a.appendChild(o),a.appendChild(d),a.appendChild(c),a.appendChild(i),a.appendChild(s),a.appendChild(l),a.appendChild(m),a.appendChild(x),a.appendChild(p),a.appendChild(u),a.appendChild(g),"Medido"===r.id_servicetype){const o=document.createElement("TD");o.className="px-4 py-1",o.textContent=t.medido.lectura_actual;const n=document.createElement("TD");n.className="px-4 py-1",n.textContent=t.medido.diferencia_lectura_anterior;const d=document.createElement("TD");d.className="px-4 py-1",d.textContent=t.medido.excedido;const r=document.createElement("TD");r.className="px-4 py-1",r.textContent=t.medido.costo_excedido;const c=document.createElement("TD");c.className="px-4 py-1",c.textContent=t.medido.iva_lim_exc;const i=document.createElement("TD");return i.className="px-4 py-1 text-right",i.textContent=t.total.general_excedido,a.appendChild(o),a.appendChild(n),a.appendChild(d),a.appendChild(r),a.appendChild(c),a.appendChild(i),void e.appendChild(a)}a.appendChild(y),e.appendChild(a)}))},x=(t=!1)=>{l=[];const a=e.querySelectorAll("input[type='checkbox']:checked");0!==a.length?(a.forEach((e=>{const t=e.parentElement.parentElement;l.find((e=>e==t.dataset.idx))||(l=[...l,t.dataset.idx])})),y(t)):Alerta.Toast.fire({icon:"error",title:"Campos vacíos",text:"Debe seleccionar al menos un mes"})};const g=()=>{c=[],i=[],s=[],p=[],m()},y=e=>{let t=[],a=l.map((e=>t=[...t,c.find((t=>t.idxDB==e))]));p=a[a.length-1],Swal.fire({title:`Desea realizar ${e?"la siguiente condonación":"el siguiente pago"} `,html:`<p>¿Está seguro de ${e?"condonar":"pagar"} los siguientes meses?</p>\n            <ul style="padding:1rem">\n                ${p.map((e=>`\n                  <li style="text-transform: uppercase; text-align:left;">\n                    ${formatDateMY(e.fecha)} - $ ${formatNum(e.total.general_excedido)} MXN\n                  </li>`)).join("")}\n            </ul>`,showDenyButton:!0,confirmButtonText:"Aplicar",denyButtonText:"No aplicar"}).then((t=>{t.isConfirmed?e?(async()=>{const e=`${location.origin}/condonacion-parcial`,t=await PostDatos.enviarArray(e,l);"Exito"===t.tipo&&(Swal.fire({icon:"success",title:t.title,text:t.text}),g())})():async function(){formarData();const e=new FormData;e.append("id_user",idUsusuario()),e.append("mes_inicio",n.fechaI),e.append("mes_fin",n.fechaF),e.append("monto_agua",n.totalAgua.toFixed(2)),e.append("monto_drenaje",n.totalDrenaje.toFixed(2)),e.append("monto_iva_agua",n.totalIvaAgua.toFixed(2)),e.append("monto_iva_drenaje",n.totalIvaDrenaje.toFixed(2)),e.append("monto_recargo_agua",n.totalRecAgua.toFixed(2)),e.append("monto_recargo_drenaje",n.totalRecDrenaje.toFixed(2)),e.append("numero_meses",n.meses),e.append("tipo_pago",n.tipoPago),e.append("total",n.total.toFixed(2));try{const t=`${location.origin}/api/pago-parcial`,a=await fetch(t,{method:"POST",body:e}),o=await a.json();console.log(o),"Exito"===o.tipo&&(Swal.fire({title:`Pago guardado correctamente con folio ${o.folio}`,text:"El pago se ha guardado correctamente",icon:"success",confirmButtonText:"Mostrar recibo",allowOutsideClick:!1,allowEscapeKey:!1}).then((e=>{e.isConfirmed&&window.open(`pdf/recibo?folio=${o.folio}&id=${d.id}`,"_blank")})),g())}catch(e){console.log(e)}}():t.isDenied&&Swal.fire("Cambios no aplicados","","warning")}))}})();