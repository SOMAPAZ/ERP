import{formatDateText,getSearch,limpiarHTML,formatNum,formatDateMY,getLocalStorage}from"../helpers/index_v1.js";import GetDatos from"../classes/GetData_v1.js";import Alerta from"../classes/Alerta_v1.js";import PostDatos from"../classes/PostData_v1.js";(()=>{const e=document.querySelector("#adeudo-desglose tbody"),t=document.querySelector("#btn-pago-parcial"),a=document.querySelector("#btn-condonar-parcial"),n=document.querySelector("#realizar-desc"),o=document.querySelector("#periodo-label");let r=[],c=[],d=[],s=[],i=[],l=[];document.addEventListener("DOMContentLoaded",(()=>{p(),t.addEventListener("click",(()=>u())),a.addEventListener("click",(()=>u(!0))),n.addEventListener("click",x)}));const p=async()=>{const e=getSearch().usuario,t=`${location.origin}/api/usuario?id=${e}`,a=`${location.origin}/deuda-usuario?id=${e}`,n=`${location.origin}/deuda-desglosada?id=${e}`;[r,d,c]=await Promise.all([GetDatos.consultar(t),GetDatos.consultar(a),GetDatos.consultar(n)]),m()},m=()=>{limpiarHTML(o),limpiarHTML(e);const t=document.createElement("P");t.className="text-center my-5 py-5 text-sm uppercase font-bold border border-dashed border-gray-300 rounded dark:bg-gray-700 dark:text-gray-300",t.textContent=`Periodo: ${formatDateText(d.periodo.inicio)} a ${formatDateText(d.periodo.final)}`,o.appendChild(t),c.map((t=>{const a=document.createElement("TR");a.className="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600",a.dataset.idx=t.idxDB;const n=document.createElement("TD");n.className="w-4 py-1 px-4";const o=document.createElement("INPUT");o.type="checkbox",o.className="w-6 h-6 text-blue-600 bg-gray-100 border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 cursor-pointer disabled:cursor-not-allowed",t.medido.lectura_actual>0&&"Medido"===r.id_servicetype||"Fijo"===r.id_servicetype?o.disabled=!1:o.disabled=!0,n.appendChild(o);const c=document.createElement("TH");c.scope="row",c.className="px-4 py-1 font-medium text-gray-900 whitespace-nowrap dark:text-white",c.textContent=t.year;const d=document.createElement("TD");d.className="px-4 py-1",d.textContent=t.mes;const s=document.createElement("TD");s.className="px-4 py-1",s.textContent=t.tarifa;const i=document.createElement("TD");i.className="px-4 py-1",i.textContent=t.tarifa-t.agua;const l=document.createElement("TD");l.className="px-4 py-1",l.textContent=t.agua;const p=document.createElement("TD");p.className="px-4 py-1",p.textContent=t.drenaje;const m=document.createElement("TD");m.className="px-4 py-1",m.textContent=t.rec_agua;const u=document.createElement("TD");u.className="px-4 py-1",u.textContent=t.rec_drain;const x=document.createElement("TD");x.className="px-4 py-1",x.textContent=t.iva_agua;const g=document.createElement("TD");g.className="px-4 py-1",g.textContent=t.iva_drenaje;const y=document.createElement("TD");if(y.className="px-4 py-1",y.textContent=t.total.general,a.appendChild(n),a.appendChild(c),a.appendChild(d),a.appendChild(s),a.appendChild(i),a.appendChild(l),a.appendChild(m),a.appendChild(x),a.appendChild(p),a.appendChild(u),a.appendChild(g),"Medido"===r.id_servicetype){const n=document.createElement("TD");n.className="px-4 py-1",n.textContent=t.medido.lectura_actual;const o=document.createElement("TD");o.className="px-4 py-1",o.textContent=t.medido.diferencia_lectura_anterior;const r=document.createElement("TD");r.className="px-4 py-1",r.textContent=t.medido.excedido;const c=document.createElement("TD");c.className="px-4 py-1",c.textContent=t.medido.costo_excedido;const d=document.createElement("TD");d.className="px-4 py-1",d.textContent=t.medido.iva_lim_exc;const s=document.createElement("TD");return s.className="px-4 py-1 text-right",s.textContent=t.total.general_excedido,a.appendChild(n),a.appendChild(o),a.appendChild(r),a.appendChild(c),a.appendChild(d),a.appendChild(s),void e.appendChild(a)}a.appendChild(y),e.appendChild(a)}))},u=(t=!1)=>{s=[];const a=e.querySelectorAll("input[type='checkbox']:checked");0!==a.length?(a.forEach((e=>{const t=e.parentElement.parentElement;s.find((e=>e==t.dataset.idx))||(s=[...s,t.dataset.idx])})),y(t)):Alerta.Toast.fire({icon:"error",title:"Campos vacíos",text:"Debe seleccionar al menos un mes"})},x=()=>{console.log("descontando")};const g=()=>{c=[],d=[],copiaDebt=[],i=[],p()},y=e=>{let t=[],a=s.map((e=>t=[...t,c.find((t=>t.idxDB==e))]));i=a[a.length-1],l=getLocalStorage("costosAdicionales")?getLocalStorage("costosAdicionales"):[],Swal.fire({title:`Desea realizar ${e?"la siguiente condonación":"el siguiente pago"} `,html:`<p>¿Está seguro de ${e?"condonar":"pagar"} los siguientes meses?</p>\n            <ul style="padding:1rem">\n                ${i.map((e=>`\n                  <li style="text-transform: uppercase; text-align:left;">\n                    ${formatDateMY(e.fecha)} - $ ${formatNum(e.total.general_excedido)} MXN\n                  </li>`)).join("")}\n            </ul>\n            <hr/>\n                ${l.length>0?l.map((e=>`\n                        <p style="text-transform: uppercase; text-align:left; margin-top:1rem;">Costos adicionales</p>\n                        <li style="text-transform: uppercase; text-align:left; margin-top:1rem;">\n                            ${e.cuenta} - $ ${formatNum(e.cantidad)} MXN\n                        </li>`)).join(""):'<li style="text-transform: uppercase; text-align:left; margin-top:1rem;">No hay costos adicionales</li>'}\n            `,showDenyButton:!0,confirmButtonText:"Aplicar",denyButtonText:"No aplicar"}).then((t=>{t.isConfirmed?e?(async()=>{const e=`${location.origin}/condonacion-parcial`,t=await PostDatos.enviarArray(e,s);"Exito"===t.tipo&&(Swal.fire({icon:"success",title:t.title,text:t.text}),g())})():async function(){console.log(i),console.log(l)}():t.isDenied&&Swal.fire("Cambios no aplicados","","warning")}))}})();