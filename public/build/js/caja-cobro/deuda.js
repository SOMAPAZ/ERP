import Alerta from"../classes/Alerta_v1.js";import{deleteLocalStorage,formatDateText,formatNum,getLocalStorage,limpiarHTML,saveLocalStorage}from"../helpers/index_v1.js";import GetDatos from"../classes/GetData_v1.js";(()=>{const e=document.querySelector("#formulario-busqueda"),a=document.querySelector("#error"),t=document.querySelector("#busqueda"),n=document.querySelector("#datos-usuario"),s=document.querySelector("#deuda-usuario"),o=document.querySelector("#boton");let r,d="",l=[],c=[];document.addEventListener("DOMContentLoaded",(function(){r=getLocalStorage("idUsuario"),null!==r&&p(r),e.addEventListener("submit",i)}));const i=e=>{limpiarHTML(document.querySelector("#listado-coincidencias ul")),e.preventDefault(),d=t.value.trim(),""!==d?(r=null,deleteLocalStorage("idUsuario"),m()):new Alerta({msg:"Debe ingresar un ID, Nombre o Dirección Válido",position:a})},p=async e=>{const a=`${location.origin}/api/usuario?id=${e}`,t=`${location.origin}/deuda-usuario?id=${e}`;[l,c]=await Promise.all([GetDatos.consultar(a),GetDatos.consultar(t)]),u(),g()},m=()=>{let a;const t=d.indexOf(" - ");if(-1===t){if(isNaN(parseInt(d)))return void Alerta.Toast.fire({icon:"error",title:`'${d}' no es un ID válido`});a=parseInt(d)}else a=parseInt(d.substring(0,t));saveLocalStorage("idUsuario",a),p(a),e.reset()},u=()=>{if("Error"===l.tipo)return void Alerta.Toast.fire({icon:"warning",title:l.msg});limpiarHTML(n);const e=document.createElement("DIV");e.className="rounded-lg border bg-white dark:border-gray-700 dark:bg-gray-800 dark:text-white shadow-sm w-full mx-auto px-4 md:px-10";const a=document.createElement("DIV");a.className="space-y-1.5 p-4 flex flex-row items-center gap-4";const t=document.createElement("SPAN");t.className="relative flex shrink-0 overflow-hidden rounded-full w-16 h-16",t.innerHTML=`<img class="aspect-square h-full w-full" alt=${l.user} src="https://api.dicebear.com/6.x/initials/svg?seed=${l.user}">`,a.appendChild(t);const s=document.createElement("DIV");s.className="space-y-1.5 p-6 flex flex-row items-center gap-4",s.innerHTML=`\n    <div>\n      <div class="text-2xl font-semibold leading-none tracking-tight uppercase">\n        ${l.user} ${l.lastname}\n      </div>\n      <p class="text-sm"><span class="font-bold">ID:</span> ${l.id}</p>\n    </div>`,a.appendChild(s);const o=document.createElement("DIV");o.className="p-6 pt-0 grid gap-4";const r=document.createElement("DIV");r.className="grid sm:grid-cols-1 md:grid-cols-2 gap-2";const d=document.createElement("DIV");d.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Dirección: </span><span class="text-sm font-medium">${l.direccion||"Sin Dirección registrada"}</span>`;const c=document.createElement("DIV");c.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Correo: </span><span class="text-sm font-medium">${l.correo||"Sin Correo registrado"}</span>`;const i=document.createElement("DIV");i.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">RFC: </span><span class="text-sm font-medium">${l.rfc||"Sin RFC registrado"}</span>`;const p=document.createElement("DIV");p.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Colonia: </span><span class="text-sm font-medium">${l.id_colony||"Sin Colonia Registrada"}</span>`;const m=document.createElement("DIV");m.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Estado: </span><span class="text-sm font-medium">${l.id_servicestatus}</span>`;const u=document.createElement("DIV");u.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Tipo Servicio: </span><span class="text-sm font-medium">${l.id_servicetype}</span>`;const g=document.createElement("DIV");g.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Tipo Usuario: </span><span class="text-sm font-medium">${l.id_usertype}</span>`;const x=document.createElement("DIV");x.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Tipo toma: </span><span class="text-sm font-medium">${l.id_intaketype} - ${l.id_consumtype}</span>`;const f=document.createElement("DIV");f.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Otro: </span><span class="text-sm font-medium">${parseInt(l.drain)?"Con Drenaje":"Sin Drenaje"}</span>`,r.appendChild(d),r.appendChild(c),r.appendChild(i),r.appendChild(p),r.appendChild(m),r.appendChild(u),r.appendChild(g),r.appendChild(x),r.appendChild(f),o.appendChild(r),e.appendChild(a),e.appendChild(o),n.appendChild(e)},g=()=>{if(limpiarHTML(s),limpiarHTML(o),"Error"===c.tipo)return void Alerta.Toast.fire({icon:"warning",title:c.msg});if("debe"===c.estado){const e=document.createElement("DIV");e.className="bg-white rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white shadow w-full mx-auto px-4 md:px-10 py-6";const a=document.createElement("DIV");a.className="flex flex-col md:flex-row justify-center items-center gap-8 font-bold uppercase text-center";const t=document.createElement("P");t.className="mb-3 font-bold uppercase text-lg",t.textContent="Periodo de adeudo:";const n=document.createElement("P");n.innerHTML=`Inicio: <span class="font-normal">${formatDateText(c.periodo.inicio)}</span>`;const o=document.createElement("P");o.innerHTML=`Fin: <span class="font-normal">${formatDateText(c.periodo.final)}</span>`,e.appendChild(t),a.appendChild(n),a.appendChild(o),e.appendChild(a),s.appendChild(e)}const e=document.createElement("DIV");e.className="bg-white rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white shadow w-full mx-auto px-4 md:px-10 py-6 mt-6";const a=document.createElement("A");if(a.className="text-gray-900 dark:text-white flex items-center justify-center sm:w-full md:w-auto uppercase text-xs py-2 px-6 rounded-sm gap-2",a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-red-800 dark:text-red-300"><path stroke-linecap="round" stroke-linejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5m6 4.125 2.25 2.25m0 0 2.25 2.25M12 13.875l2.25-2.25M12 13.875l-2.25 2.25M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" /></svg><p class="font-bold text-xs text-red-800 dark:text-red-300">Condonaciones</p>',a.href=`/consultar-condonaciones?usuario=${l.id}`,"pagado"===c.estado){const t=document.createElement("P");return t.className="text-center font-black uppercase text-lg",t.textContent=c.msg,e.appendChild(t),s.appendChild(e),void o.appendChild(a)}const t=document.createElement("P");t.className="mb-3 font-bold uppercase text-lg",t.textContent="Información del adeudo";const n=document.createElement("UL");n.className="grid grid-cols-1 sm:grid-cols-2";const r=document.createElement("LI");r.innerHTML=`<span class="font-bold">Agua inicial:</span> $ ${formatNum(c.agua_inicial)}`;const d=document.createElement("LI");d.innerHTML=`<span class="font-bold">Drenaje incial:</span> $ ${formatNum(c.drenaje_inicial)}`;const i=document.createElement("LI");i.innerHTML=`<span class="font-bold">Agua a pagar:</span> $ ${formatNum(c.agua)}`;const p=document.createElement("LI");p.innerHTML=`<span class="font-bold">Drenaje a pagar:</span> $ ${formatNum(c.drenaje)}`;const m=document.createElement("LI");m.innerHTML=`\n    <div>\n      <span class="font-bold">Recargos:</span> $ ${formatNum(c.recargos.total)}\n      <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Agua: <span class="font-normal">\n        $  ${formatNum(c.recargos.agua)}\n      </span></p>\n      <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Drenaje: <span class="font-normal">\n        $  ${formatNum(c.recargos.drenaje)}\n      </span></p>\n    </div>\n    `;const u=document.createElement("LI");u.innerHTML=`\n    <div>\n    <span class="font-bold">IVA:</span> $ ${formatNum(c.iva.total)}\n    <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Agua: <span class="font-normal">\n    $ ${formatNum(c.iva.agua)}\n    </span></p>\n    <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Drenaje: <span class="font-normal">\n      $ ${formatNum(c.iva.drenaje)}\n    </span></p>\n    ${c.m3_excedido_agua>0?`\n      <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Exc Agua: <span class="font-normal">\n      $ ${formatNum(c.iva.m3_excedido_agua)}\n      </span></p>\n      <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Exc Drenaje: <span class="font-normal">\n      $ ${formatNum(c.iva.m3_excedido_drenaje)}\n      </span></p>`:""}\n    </div>\n    `;const g=document.createElement("LI");g.innerHTML=`\n    <div>\n    <span class="font-bold">Meses totales:</span> ${c.meses.totales}\n    <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Rezagados: <span class="font-normal">${c.meses.rezagados}</span></p>\n    <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Naturales: <span class="font-normal">${c.meses.naturales}</span></p>\n    </div>\n    `;const x=document.createElement("LI");x.innerHTML=`\n    <div>\n      <span class="font-bold">Descuento total aplicable:</span> $ ${formatNum(c.descuentos.total)}\n      <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Agua: <span class="font-normal">$ ${formatNum(c.descuentos.agua)}</span></p>\n      <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Drenaje: <span class="font-normal">$ ${formatNum(c.descuentos.drenaje)}</span></p>\n    </div>\n    `;const f=document.createElement("LI");if(f.className="text-2xl text-gray-900 underline dark:text-yellow-200",f.innerHTML=`<span class="font-black">Total:</span> $ ${formatNum(c.total)}`,n.appendChild(r),n.appendChild(d),n.appendChild(i),n.appendChild(p),n.appendChild(m),c.excedio>0){const e=document.createElement("LI");e.innerHTML=`\n      <div>\n        <span class="font-bold">Excedido Medido:</span> $ ${formatNum(c.m3_excedido_agua+c.m3_excedido_drenaje)}\n        <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Agua: <span class="font-normal">\n        $ ${formatNum(c.m3_excedido_agua)}\n        </span></p>\n        <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Drenaje: <span class="font-normal">\n        $ ${formatNum(c.m3_excedido_drenaje)}\n        </span></p>\n      </div>\n      `,n.appendChild(e)}n.appendChild(x),n.appendChild(u),n.appendChild(g),n.appendChild(f),e.appendChild(t),e.appendChild(n),s.appendChild(e);const h=document.createElement("A");h.className="py-2 px-4 bg-gray-200 dark:bg-gray-700 rounded text-sm text-gray-800 dark:text-white my-4 hover:bg-gray-300 dark:hover:bg-gray-600 font-semibold flex flex-row gap-2 items-center uppercase",h.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" /></svg><p class="font-bold text-xs">Realizar pago</p>';(new Date).getMonth()>=2&&"Medido"===l.id_servicetype||"Medido"===l.id_servicetype&&c.recargos.total>0?(h.setAttribute("disabled",!0),h.classList.add("opacity-50"),h.classList.add("cursor-not-allowed")):(h.href=`/pagar-total?usuario=${l.id}`,h.classList.remove("opacity-50"),h.classList.remove("cursor-not-allowed"));const y=document.createElement("A");y.className="text-gray-900 dark:text-white flex items-center justify-center sm:w-full md:w-auto uppercase text-xs py-2 px-6 rounded-sm gap-2",y.innerHTML='<svg class="h-6 w-6 text-gray-900 dark:text-white"  width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">  <path stroke="none" d="M0 0h24v24H0z"/>  <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />  <circle cx="12" cy="12" r="3" /></svg><p class="font-bold text-xs">Desglose</p>',y.href=`/consultar-avanzados?usuario=${l.id}`,o.appendChild(h),o.appendChild(y),o.appendChild(a)}})();