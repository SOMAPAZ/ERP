import Alerta from"../classes/Alerta.js";import{formatNum,limpiarHTML,roundAndFloat}from"../helpers/funciones.js";import GetDatos from"../classes/GetData.js";import Modal from"../classes/Modal.js";import PostDatos from"../classes/PostData.js";(()=>{const e=document.querySelector("#formulario-busqueda"),t=document.querySelector("#error"),a=document.querySelector("#busqueda"),n=(document.querySelector("#listado-coincidencias ul"),document.querySelector("#datos-usuario")),o=document.querySelector("#deuda-usuario"),r=document.querySelector("#boton");let s="",d=[],l=[],c=[],i={agua:0,drenaje:0,aguaIVA:0,drenajeIVA:0,recargoAgua:0,recargoDrenaje:0,meses:0,total:0,tipoPago:1};document.addEventListener("DOMContentLoaded",(function(){e.addEventListener("submit",p)}));const p=e=>{e.preventDefault(),s=a.value.trim(),""!==s?u():new Alerta({msg:"Debe ingresar un ID, Nombre o Dirección Válido",position:t})},m=async e=>{const t=`${location.origin}/api/usuario?id=${e}`,a=`${location.origin}/deuda-usuario?id=${e}`;[d,l]=await Promise.all([GetDatos.consultar(t),GetDatos.consultar(a)]),g(),x(l)},u=()=>{let t;const a=s.indexOf(" - ");if(-1===a){if(isNaN(parseInt(s)))return void Alerta.Toast.fire({icon:"error",title:`'${s}' no es un ID válido`});t=parseInt(s)}else t=parseInt(s.substring(0,a));m(t),e.reset()},g=()=>{limpiarHTML(n);const e=document.createElement("DIV");e.className="rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white shadow-sm w-full mx-auto px-4 md:px-10";const t=document.createElement("DIV");t.className="space-y-1.5 p-4 flex flex-row items-center gap-4";const a=document.createElement("SPAN");a.className="relative flex shrink-0 overflow-hidden rounded-full w-16 h-16",a.innerHTML=`<img class="aspect-square h-full w-full" alt=${d.user} src="https://api.dicebear.com/6.x/initials/svg?seed=${d.user}">`,t.appendChild(a);const o=document.createElement("DIV");o.className="space-y-1.5 p-6 flex flex-row items-center gap-4",o.innerHTML=`\n    <div>\n      <div class="text-2xl font-semibold leading-none tracking-tight uppercase">\n        ${d.user} ${d.lastname}\n      </div>\n      <p class="text-sm"><span class="font-bold">ID:</span> ${d.id}</p>\n    </div>`,t.appendChild(o);const r=document.createElement("DIV");r.className="p-6 pt-0 grid gap-4";const s=document.createElement("DIV");s.className="grid sm:grid-cols-1 md:grid-cols-2 gap-2";const l=document.createElement("DIV");l.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Dirección: </span><span class="text-sm font-medium">${d.direccion||"Sin Dirección registrada"}</span>`;const c=document.createElement("DIV");c.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Correo: </span><span class="text-sm font-medium">${d.correo||"Sin Correo registrado"}</span>`;const i=document.createElement("DIV");i.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">RFC: </span><span class="text-sm font-medium">${d.rfc||"Sin RFC registrado"}</span>`;const p=document.createElement("DIV");p.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Colonia: </span><span class="text-sm font-medium">${d.id_colony||"Sin Colonia Registrada"}</span>`;const m=document.createElement("DIV");m.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Estado: </span><span class="text-sm font-medium">${d.id_servicestatus}</span>`;const u=document.createElement("DIV");u.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Tipo Servicio: </span><span class="text-sm font-medium">${d.id_servicetype}</span>`;const g=document.createElement("DIV");g.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Tipo Usuario: </span><span class="text-sm font-medium">${d.id_usertype}</span>`;const x=document.createElement("DIV");x.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Tipo toma: </span><span class="text-sm font-medium">${d.id_intaketype} - ${d.id_consumtype}</span>`;const f=document.createElement("DIV");f.innerHTML=`<span class="text-sm font-bold dark:text-gray-400">Otro: </span><span class="text-sm font-medium">${parseInt(d.drain)?"Con Drenaje":"Sin Drenaje"}</span>`,s.appendChild(l),s.appendChild(c),s.appendChild(i),s.appendChild(p),s.appendChild(m),s.appendChild(u),s.appendChild(g),s.appendChild(x),s.appendChild(f),r.appendChild(s),e.appendChild(t),e.appendChild(r),n.appendChild(e)},x=(e,t=!1)=>{limpiarHTML(o),limpiarHTML(r);const a=document.createElement("DIV");if(a.className="rounded-lg border dark:border-gray-700 dark:bg-gray-800 dark:text-white shadow w-full mx-auto px-4 md:px-10 py-6","pagado"===e.estado){const t=document.createElement("P");return t.className="text-center font-black uppercase text-lg",t.textContent=e.msg,a.appendChild(t),void o.appendChild(a)}const n=document.createElement("P");n.className="mb-3 font-bold uppercase text-lg",n.textContent="Información del adeudo";const s=document.createElement("UL");s.className="grid grid-cols-1 sm:grid-cols-2";const l=document.createElement("LI");l.innerHTML=`<span class="font-bold">Agua</span>: $ ${formatNum(e.agua)}`;const c=document.createElement("LI");c.innerHTML=`<span class="font-bold">Drenaje:</span> $ ${formatNum(e.drenaje)}`;const i=document.createElement("LI");i.innerHTML=`\n    <div>\n      <span class="font-bold">Recargos:</span> $ ${formatNum(e.recargos.total)}\n      <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Agua: <span class="font-normal">\n        $  ${formatNum(e.recargos.agua)}\n      </span></p>\n      <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Drenaje: <span class="font-normal">\n        $  ${formatNum(e.recargos.drenaje)}\n      </span></p>\n    </div>\n    `;const p=document.createElement("LI");p.innerHTML=`\n    <div>\n    <span class="font-bold">IVA:</span> $ ${formatNum(e.iva.total)}\n    <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Agua: <span class="font-normal">\n    $ ${formatNum(e.iva.agua)}\n    </span></p>\n    <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Drenaje: <span class="font-normal">\n    $ ${formatNum(e.iva.drenaje)}\n    </span></p>\n    </div>\n    `;const m=document.createElement("LI");m.innerHTML=`\n    <div>\n      <span class="font-bold">Meses totales:</span> ${e.meses.totales}\n        <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Rezagados: <span class="font-normal">${e.meses.rezagados}</span></p>\n      <p class="font-bold text-gray-600 dark:text-gray-400 ms-6">- Naturales: <span class="font-normal">${e.meses.naturales}</span></p>\n    </div>\n    `;const u=document.createElement("LI");u.className="text-2xl text-gray-900 underline dark:text-yellow-200",u.innerHTML=`<span class="font-black">Total:</span> $ ${formatNum(e.total)}`,s.appendChild(l),s.appendChild(c),s.appendChild(i),s.appendChild(p),s.appendChild(m),s.appendChild(u),a.appendChild(n),a.appendChild(s),o.appendChild(a);const g=document.createElement("BUTTON");g.className="text-white text-lg flex items-center justify-center sm:w-full md:w-auto uppercase bg-gray-500 dark:bg-gray-700 text-lg py-2 px-6 rounded-sm hover:bg-gray-300 hover:text-gray-800 dark:hover:bg-gray-600 gap-2",g.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" /></svg><p class="font-bold text-xs">Pagar</p>',g.onclick=f;const x=document.createElement("BUTTON");x.className="text-gray-800 dark:text-white flex items-center justify-center sm:w-full md:w-auto uppercase bg-gray-200 dark:bg-gray-800 text-xs py-2 px-6 rounded-sm hover:bg-gray-300 dark:hover:bg-gray-600 gap-2",x.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg><p class="font-bold text-xs">Descuento</p>',x.id="btnDescRecPorc",x.onclick=h;const y=document.createElement("A");y.className="text-gray-900 dark:text-white flex items-center justify-center sm:w-full md:w-auto uppercase text-xs py-2 px-6 rounded-sm gap-2",y.innerHTML='<svg class="h-6 w-6 text-gray-900 dark:text-white"  width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">  <path stroke="none" d="M0 0h24v24H0z"/>  <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />  <circle cx="12" cy="12" r="3" /></svg><p class="font-bold text-xs">Configurar</p>',y.href=`/consultar-avanzados?usuario=${d.id}`;const w=document.createElement("BUTTON");w.className="text-red-800 dark:text-white flex items-center justify-center sm:w-full md:w-auto uppercase bg-red-200 dark:bg-red-800 text-xs py-2 px-6 rounded-sm hover:bg-red-300 dark:hover:bg-red-600 gap-2",w.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg><p class="font-bold text-xs">Eliminar descuento</p>',w.onclick=()=>b(),r.appendChild(g),r.appendChild(x),t&&r.appendChild(w),r.appendChild(y)},f=()=>{Swal.fire({title:`¿Realizar pago por $${formatNum(l.total)} MN?`,text:"Esta acción no se puede deshacer",icon:"warning",showCancelButton:!0,confirmButtonText:"Confirmar pago",cancelButtonText:"Cancelar"}).then((e=>e.isConfirmed?async function(){const e=function(){const e=fechas.map((e=>new Date(e))),t=new Date(Math.max.apply(null,e));return{min:new Date(Math.min.apply(null,e)),max:t}}();document.querySelectorAll("input[type='radio']").forEach((e=>{e.checked&&(i.tipoPago=e.value)}));const t=new FormData;t.append("id_user",usuario_informacion.id),t.append("mes_incio",e.min.toLocaleDateString("en-US")),t.append("mes_fin",e.max.toLocaleDateString("en-US")),t.append("monto_agua",i.agua),t.append("monto_drenaje",i.drenaje),t.append("monto_iva_agua",i.aguaIVA),t.append("monto_iva_drenaje",i.drenajeIVA),t.append("monto_recargo_agua",i.recargoAgua),t.append("monto_recargo_drenaje",i.recargoDrenaje),t.append("numero_meses",i.meses),t.append("tipo_pago",i.tipoPago),t.append("monto_descuento_recargo_agua",RecNaturalAgua?Number(RecNaturalAgua):0),t.append("monto_descuento_recargo_drenaje",RecNaturalDrenaje?Number(RecNaturalDrenaje):0),t.append("total",i.total);try{const e=`${location.origin}/api/pago-total`,a=await fetch(e,{method:"POST",body:t}),n=await a.json();"Exito"===n.tipo&&(Swal.fire({title:`Pago guardado correctamente con folio ${n.folio}`,text:"El pago se ha guardado correctamente",icon:"success",confirmButtonText:"Mostrar recibo",allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1}).then((e=>{e.isConfirmed&&window.open(`pdf/recibo?folio=${n.folio}&id=${usuario_informacion.id}`,"_blank")})),limpiarHTML(document.querySelector("#radio_inputs")),limpiarHTML(r),m(usuario_informacion.id),fechas=[])}catch(e){console.log(e)}}():""))};const h=()=>{const e=document.createElement("FORM");e.className="p-4 md:p-5",e.innerHTML='<svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>',e.onsubmit=e=>e.preventDefault();const t=document.createElement("H3");t.className="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400",t.textContent="Ingrese el monto de recargos a descontar";const a=document.createElement("DIV");a.id="div-notif";const n=document.createElement("BUTTON");n.className="text-xs font-semibold rounded-sm text-yellow-900 hover:bg-yellow-900 hover:text-white border border-yellow-900 px-3 py-1 dark:text-yellow-200 dark:border-yellow-200 dark:hover:bg-yellow-200 dark:hover:text-gray-900 mb-2",n.textContent="Porcentaje",n.type="button",n.id="botton-desc-tipo",n.dataset.tipo=1,n.ondblclick=e=>y(e);const o=document.createElement("INPUT");o.className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 mb-4 text-gray-900 placeholder:text-gray-400 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:placeholder:text-gray-500",o.type="number",o.name="descuento";const r=document.createElement("BUTTON");r.className="text-white bg-red-600 hover:bg-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center",r.textContent="Calcular",r.onclick=e=>function(e){e.preventDefault();const t=e.target.parentElement.parentElement,a=t.querySelectorAll("input");PostDatos.crearFormData(a);const n=t.querySelector("input").value;let o=0;const r=document.querySelector(".default-modal #botton-desc-tipo").dataset.tipo;if(c=structuredClone(l),"1"===r){if(n>100)return void Alerta.Toast.fire({icon:"error",title:"Debe ingresar un porcentaje menor al 100%"});o=n}if("2"===r){const e=parseFloat(n);if(e>l.recargos.total)return void Alerta.Toast.fire({icon:"error",title:"Debe ingresar una cantidad menor al total de recargos"});o=100*e/l.recargos.total}return c.recargos.agua=roundAndFloat(l.recargos.agua-l.recargos.agua*(o/100)),c.recargos.drenaje=roundAndFloat(l.recargos.drenaje-l.recargos.drenaje*(o/100)),c.recargos.total=roundAndFloat(l.recargos.total-l.recargos.total*(o/100)),c.total=roundAndFloat(c.total-l.recargos.total*(o/100)),x(c,!0),document.querySelector("#btnDescRecPorc").classList.add("hidden"),void document.querySelector(".default-modal")?.remove()}(e),e.appendChild(t),e.appendChild(a),e.appendChild(o),e.appendChild(n),e.appendChild(r),Modal.renderModal(e,r)},y=e=>{e.preventDefault();let t=e.target;t.parentElement.querySelector("input").value="","1"===t.dataset.tipo?t.textContent="Pesos":t.textContent="Porcentaje","1"===t.dataset.tipo?t.dataset.tipo=2:t.dataset.tipo=1};const b=()=>{x(l),c=[],document.querySelector("#btnDescRecPorc").classList.remove("hidden")}})();