import{formatDateText,getSearch,limpiarHTML,formatNum,formatDateMY,getLocalStorage,roundAndFloat,deleteLocalStorage}from"../helpers/index_v1.js";import GetDatos from"../classes/GetData_v1.js";import Alerta from"../classes/Alerta_v1.js";import PostDatos from"../classes/PostData_v1.js";import Descuento from"../classes/Descuento_v1.js";(()=>{const e=document.querySelector("#adeudo-desglose tbody"),t=document.querySelector("#btn-calcular-parcial"),a=document.querySelector("#div-btn-acciones"),n=document.querySelector("#btn-pago-parcial"),o=document.querySelector("#btn-condonar-parcial"),r=document.querySelector("#realizar-desc"),c=document.querySelector("#eliminar-desc"),d=document.querySelector("#periodo-label"),s=document.querySelector("#monto-seleccionado"),i=document.querySelectorAll('input[name="tipo_pago"]');let l=[],m=[],u=[],p=[],g=[],x=[],f=0,h=0,y=1;document.addEventListener("DOMContentLoaded",(()=>{C(),t.addEventListener("click",D),n.addEventListener("click",(()=>$())),o.addEventListener("click",(()=>$(!0))),r.addEventListener("click",T),i.forEach((e=>e.addEventListener("click",(()=>{y=e.value}))))}));const C=async()=>{const e=getSearch().usuario,t=`${location.origin}/api/usuario?id=${e}`,a=`${location.origin}/deuda-usuario?id=${e}`,n=`${location.origin}/deuda-desglosada?id=${e}`;[l,u,m]=await Promise.all([GetDatos.consultar(t),GetDatos.consultar(a),GetDatos.consultar(n)]),_()},_=()=>{limpiarHTML(d),limpiarHTML(e);const t=document.createElement("P");t.className="text-center my-5 py-5 text-sm uppercase font-bold border border-dashed border-gray-300 rounded dark:bg-gray-700 dark:text-gray-300",t.textContent=`Periodo: ${formatDateText(u.periodo.inicio)} a ${formatDateText(u.periodo.final)}`,d.appendChild(t);let n=0;m.map((t=>{const o=document.createElement("TR");o.className="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600",o.dataset.idx=t.idxDB;const r=document.createElement("TD");r.className="w-4 py-1 px-4";const c=document.createElement("INPUT");c.type="checkbox",c.dataset.indice=++n,c.className="w-6 h-6 text-blue-600 bg-gray-100 border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 cursor-pointer disabled:cursor-not-allowed",t.medido.lectura_actual>0&&"Medido"===l.id_servicetype||"Fijo"===l.id_servicetype?c.disabled=!1:c.disabled=!0,c.onclick=()=>{a.classList.contains("hidden")||a.classList.add("hidden")},r.appendChild(c);const d=document.createElement("TH");d.scope="row",d.className="px-4 py-1 font-medium text-gray-900 whitespace-nowrap dark:text-white",d.textContent=t.year;const s=document.createElement("TD");s.className="px-4 py-1",s.textContent=t.mes;const i=document.createElement("TD");i.className="px-4 py-1",i.textContent=t.tarifa;const m=document.createElement("TD");m.className="px-4 py-1",m.textContent=t.tarifa-t.agua;const u=document.createElement("TD");u.className="px-4 py-1",u.textContent=t.agua;const p=document.createElement("TD");p.className="px-4 py-1",p.textContent=t.drenaje;const g=document.createElement("TD");g.className="px-4 py-1",g.textContent=t.desc_drenaje;const x=document.createElement("TD");x.className="px-4 py-1",x.textContent=t.rec_agua;const f=document.createElement("TD");f.className="px-4 py-1",f.textContent=t.rec_drain;const h=document.createElement("TD");h.className="px-4 py-1",h.textContent=t.iva_agua;const y=document.createElement("TD");y.className="px-4 py-1",y.textContent=t.iva_drenaje;const C=document.createElement("TD");if(C.className="px-4 py-1",C.textContent=t.total.general,o.appendChild(r),o.appendChild(d),o.appendChild(s),o.appendChild(i),o.appendChild(m),o.appendChild(u),o.appendChild(x),o.appendChild(h),o.appendChild(p),o.appendChild(g),o.appendChild(f),o.appendChild(y),"Medido"===l.id_servicetype){const a=document.createElement("TD");a.className="px-4 py-1",a.textContent=t.medido.consumo_global,console.log(t.medido.consumo_global);const n=document.createElement("TD");n.className="px-4 py-1",n.textContent=t.medido.lectura_actual;const r=document.createElement("TD");r.className="px-4 py-1",r.textContent=t.medido.diferencia_lectura_anterior;const c=document.createElement("TD");c.className="px-4 py-1",c.textContent=t.medido.excedido;const d=document.createElement("TD");d.className="px-4 py-1",d.textContent=t.medido.costo_excedido;const s=document.createElement("TD");s.className="px-4 py-1",s.textContent=t.medido.iva_lim_exc;const i=document.createElement("TD");return i.className="px-4 py-1 text-right",i.textContent=t.total.general_excedido,o.appendChild(a),o.appendChild(n),o.appendChild(r),o.appendChild(c),o.appendChild(d),o.appendChild(s),o.appendChild(i),void e.appendChild(o)}o.appendChild(C),e.appendChild(o)}))},D=()=>{p=[];const t=e.querySelectorAll("input[type='checkbox']:checked");if(0===t.length)return void Alerta.Toast.fire({icon:"error",title:"Campos vacíos",text:"Debe seleccionar al menos un mes"});let n=[];t.forEach((e=>n=[...n,+e.dataset.indice]));if(n.sort(((e,t)=>t-e)).slice(1).map(((e,t)=>n[t]-e==1)).includes(!1))return Swal.fire({icon:"error",title:"Campos saltados",text:"No puede seleccionar un mes que no sea consecutivo"}),void(g=[]);t.forEach((e=>{const t=e.parentElement.parentElement;p.find((e=>e==t.dataset.idx))||(p=[...p,t.dataset.idx])}));let o=[],d=p.map((e=>o=[...o,m.find((t=>t.idxDB==e))]));g=d[d.length-1],x=getLocalStorage("costosAdicionales")?getLocalStorage("costosAdicionales"):[],a.classList?.remove("hidden"),!a.classList.contains("flex")&&a.classList.add("flex"),!c.classList.contains("hidden")&&c.classList.add("hidden"),r.classList.contains("hidden")&&r.classList.remove("hidden"),E()},T=()=>{p=[];const t=e.querySelectorAll("input[type='checkbox']:checked");if(0===t.length)return void Alerta.Toast.fire({icon:"error",title:"Campos vacíos",text:"Debe seleccionar al menos un mes"});t.forEach((e=>{const t=e.parentElement.parentElement;p.find((e=>e==t.dataset.idx))||(p=[...p,t.dataset.idx])}));const a=document.createElement("BUTTON");a.className="text-white bg-red-600 hover:bg-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center",a.textContent="Calcular",a.onclick=e=>L(e),Descuento.formularioDescuentoRecargos(a)},L=e=>{e.preventDefault();let t=[],a=p.map((e=>t=[...t,m.find((t=>t.idxDB==e))]));g=a[a.length-1];const n=g.reduce(((e,t)=>e+t.rec_agua),0),o=g.reduce(((e,t)=>e+t.rec_drain),0),d=e.target.parentElement.parentElement,s=d.querySelectorAll("input");if(!PostDatos.crearFormData(s))return;const i=d.querySelector("input").value;let l=0;const u=document.querySelector(".default-modal #botton-desc-tipo").dataset.tipo;if("1"===u){if(i>100)return void Alerta.Toast.fire({icon:"error",title:"Debe ingresar un porcentaje menor al 100%"});l=i}if("2"===u){const e=parseFloat(i);if(e>n+o)return void Alerta.Toast.fire({icon:"error",title:"Debe ingresar una cantidad menor al total de recargos"});l=100*e/(n+o)}f=n*(l/100),h=o*(l/100);const x=g.reduce(((e,t)=>e+t.rec_agua),0),y=g.reduce(((e,t)=>e+t.rec_drain),0),C=g.reduce(((e,t)=>e+t.total.general_excedido),0);r.classList.add("hidden"),c.classList.remove("hidden"),c.onclick=()=>{f=0,h=0,c.classList.add("hidden"),r.classList.remove("hidden"),document.querySelector("#monto-agua-rec").innerHTML=`Rec Agua: <span class='font-normal'>$ ${formatNum(roundAndFloat(x))}</span>`,document.querySelector("#monto-drenaje-rec").innerHTML=`Rec Drenaje: <span class='font-normal'>$ ${formatNum(roundAndFloat(y))}</span>`,document.querySelector("#total-pago").innerHTML=`Total de $ ${formatNum(roundAndFloat(C))} MN`},document.querySelector("#monto-agua-rec").innerHTML=`Rec Agua: <span class='font-normal'>$ ${formatNum(roundAndFloat(x-f))}</span>`,document.querySelector("#monto-drenaje-rec").innerHTML=`Rec Drenaje: <span class='font-normal'>$ ${formatNum(roundAndFloat(y-h))}</span>`,document.querySelector("#total-pago").innerHTML=`Total de $ ${formatNum(roundAndFloat(C-f-h))} MN`,document.querySelector(".default-modal")?.remove()},N=()=>{m=[],u=[],g=[],x=[],C(),limpiarHTML(s),limpiarHTML(document.querySelector("#listado-adicionales ul")),document.querySelector("#listado-adicionales ul").innerHTML='<li class="text-center font-bold text-gray-700 dark:text-gray-200">No hay costos adicionales</li>',!a.classList.contains("hidden")&&a.classList.add("hidden"),s.textContent="Sin meses seleccionados",document.querySelector("#notas-form").reset()},E=()=>{const e=g.reduce(((e,t)=>e+t.total.general_excedido),0);limpiarHTML(s);const t=document.createElement("P");t.id="total-pago",t.textContent=`Total de $ ${formatNum(roundAndFloat(e))} MN`;const a=document.createElement("UL");a.className="text-gray-800 dark:text-white text-sm flex flex-col md:flex-row justify-center md:justify-between px-6";const n=document.createElement("LI"),o=g.reduce(((e,t)=>e+t.tarifa),0);n.innerHTML=`Agua: <span class='font-normal'>$ ${formatNum(roundAndFloat(o))}</span>`;const r=document.createElement("LI"),c=g.reduce(((e,t)=>e+t.desc_agua),0);r.innerHTML=`Desc Agua: <span class='font-normal'>$ ${formatNum(roundAndFloat(c))}</span>`;const d=document.createElement("LI");d.id="monto-agua-rec";const i=g.reduce(((e,t)=>e+t.rec_agua),0);d.innerHTML=`Rec Agua: <span class='font-normal'>$ ${formatNum(roundAndFloat(i))}</span>`;const l=document.createElement("LI"),m=g.reduce(((e,t)=>e+t.iva_agua),0);l.innerHTML=`IVA Agua: <span class='font-normal'>$ ${formatNum(roundAndFloat(m))}</span>`;const u=document.createElement("LI"),p=g.reduce(((e,t)=>e+t.drenaje),0);u.innerHTML=`Drenje: <span class='font-normal'>$ ${formatNum(roundAndFloat(p))}</span>`;const x=document.createElement("LI"),f=g.reduce(((e,t)=>e+t.desc_drenaje),0);x.innerHTML=`Desc Drenje: <span class='font-normal'>$ ${formatNum(roundAndFloat(f))}</span>`;const h=document.createElement("LI");h.id="monto-drenaje-rec";const y=g.reduce(((e,t)=>e+t.rec_drain),0);h.innerHTML=`Rec Drenje: <span class='font-normal'>$ ${formatNum(roundAndFloat(y))}</span>`;const C=document.createElement("LI"),_=g.reduce(((e,t)=>e+t.iva_drenaje),0);C.innerHTML=`IVA Drenje: <span class='font-normal'>$ ${formatNum(roundAndFloat(_))}</span>`,a.appendChild(n),a.appendChild(d),a.appendChild(r),a.appendChild(l),a.appendChild(u),a.appendChild(h),a.appendChild(x),a.appendChild(C),s.appendChild(t),s.appendChild(a)},$=(e=!1)=>{if(x=getLocalStorage("costosAdicionales")?getLocalStorage("costosAdicionales"):[],e&&x.length>0)return void Swal.fire({icon:"error",title:"No puedes condonar con cuentas extras",text:"Debes eliminar las cuentas antes de condonar, por favor recargue la página (Ctrl + R)"});const t=g.reduce(((e,t)=>e+t.total.general_excedido),0),a=x.reduce(((e,t)=>e+(+t.cantidad+("1"===t.iva?.16*+t.cantidad:0))),0);u.nota=document.querySelector("#notas").value,Swal.fire({title:`Desea realizar ${e?"la siguiente condonación":"el siguiente pago"} por  ${formatNum(roundAndFloat(t+a))} MXN`,html:`<p>¿Está seguro de ${e?"condonar":"pagar"} los siguientes meses?</p>\n            <ul style="padding:1rem">\n                ${g.map((e=>`\n                  <li style="text-transform: uppercase; text-align:left;">\n                    ${formatDateMY(e.fecha)} - $ ${formatNum(e.total.general_excedido)} MXN\n                  </li>`)).join("")}\n            </ul>\n            <hr/>\n                ${e?"":x.length>0?`<p style="text-transform: uppercase; text-align:left; margin-top:1rem;">Costos adicionales</p>\n                    ${x.map((e=>`\n                        <li style="text-transform: uppercase; text-align:left; margin-top:1rem;">\n                            ${e.cuenta} - $ ${formatNum(+e.cantidad+("1"===e.iva?.16*+e.cantidad:0))} MXN\n                        </li>`)).join("")}`:'<li style="text-transform: uppercase; text-align:left; margin-top:1rem;">No hay costos adicionales</li>'}\n            `,showDenyButton:!0,confirmButtonText:"Aplicar",denyButtonText:"No aplicar"}).then((t=>{t.isConfirmed&&(e?(async()=>{const e=`${location.origin}/condonacion-parcial`,t=await PostDatos.enviarArray(e,p);"Exito"===t.tipo&&(Swal.fire({icon:"success",title:t.title,text:t.text}),N())})():(async()=>{u.agua_inicial=g.reduce(((e,t)=>e+ +t.tarifa),0),u.agua=g.reduce(((e,t)=>e+ +t.agua),0),u.m3_excedido_agua=.75*g.reduce(((e,t)=>e+ +t.medido.costo_excedido),0),u.drenaje_inicial=g.reduce(((e,t)=>e+ +t.drenaje),0),u.drenaje=g.reduce(((e,t)=>e+ +t.drenaje),0),u.m3_excedido_drenaje=.25*g.reduce(((e,t)=>e+ +t.medido.costo_excedido),0),u.periodo.inicio=g[0].fecha,u.periodo.final=g[g.length-1].fecha,u.recargos.agua=g.reduce(((e,t)=>e+ +t.rec_agua),0),u.recargos.drenaje=g.reduce(((e,t)=>e+ +t.rec_drain),0),u.descuentos.agua=g.reduce(((e,t)=>e+ +t.desc_agua),0),u.descuentos.drenaje=g.reduce(((e,t)=>e+ +t.desc_drenaje),0),u.meses.totales=g.length,u.iva.agua=g.reduce(((e,t)=>e+ +t.iva_agua),0),u.iva.drenaje=g.reduce(((e,t)=>e+ +t.iva_drenaje),0),u.iva.m3_excedido_agua=.75*g.reduce(((e,t)=>e+ +t.medido.iva_lim_exc),0),u.iva.m3_excedido_drenaje=.25*g.reduce(((e,t)=>e+ +t.medido.iva_lim_exc),0),u.total=g.reduce(((e,t)=>e+t.total.general_excedido),0);const e=[{id_user:getSearch().usuario},{resDebt:u},{descuentoAgua:g.reduce(((e,t)=>e+ +t.desc_agua),0)},{descuentoRecargoAgua:f},{descuentoDren:g.reduce(((e,t)=>e+ +t.desc_drenaje),0)},{descuentoRecargoDren:h},{tipoPago:y},{adicionales:x},{seleccionado:p}],t=new FormData;t.append("montos",JSON.stringify(e));try{const e=`${location.origin}/api/pago-total`,a=await fetch(e,{method:"POST",body:t}),n=await a.json();"Exito"===n.tipo&&(N(),Swal.fire({title:`Pago guardado correctamente con folio ${n.folio}`,text:"El pago se ha guardado correctamente",icon:"success",confirmButtonText:"Mostrar recibo",allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1}).then((e=>{e.isConfirmed&&window.open(`pdf/recibo?folio=${n.folio}&id=${getSearch().usuario}`,"_blank")})))}catch(e){console.log(e)}})())}))}})();