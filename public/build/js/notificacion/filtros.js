import Modal from"../classes/Modal_v1.js";(()=>{function e(e,o,t="nombre",n="item"){const a=document.querySelector(e);a&&fetch(o).then((e=>e.json())).then((e=>{a.innerHTML="",e.forEach(((e,o)=>{const r=document.createElement("li"),c=`${n}-checkbox-${o}`;r.innerHTML=`\n          <div class="flex items-center p-2 rounded-sm hover:bg-gray-100 dark:hover:bg-gray-600">\n            <input id="${c}" type="checkbox" value="${e.id}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500">\n            <label for="${c}" class="w-full ms-2 text-sm font-medium text-gray-900 rounded-sm dark:text-gray-300">${e[t]}</label>\n          </div>`,a.appendChild(r)}))})).catch((e=>console.error(`Error al consultar ${o}:`,e)))}function o(e){const o=[];return document.querySelectorAll(`${e} input[type='checkbox']:checked`).forEach((e=>o.push(e.value))),o}function t(e){localStorage.setItem("filtrosSeleccionados",JSON.stringify(e)),document.querySelector("#filtrosInput").value=JSON.stringify(e),document.querySelector("form").submit()}function n(e,o){o.forEach((o=>{const t=document.querySelector(`${e} input[value='${o}']`);t&&(t.checked=!0)}))}function a(){const e=JSON.parse(localStorage.getItem("usuarios_agregados"))||[];if(0===e.length)return void Swal.fire({icon:"info",title:"Atención",html:'<p class="text-base text-gray-700 dark:text-gray-800">No hay usuarios seleccionados.</p>',background:"#ffffff",color:"#1f2937",confirmButtonColor:"#2563eb",confirmButtonText:"Aceptar",customClass:{popup:"dark:bg-gray-800 dark:text-gray-100 rounded-xl shadow-lg",title:"text-blue-600 dark:text-blue-400 font-semibold text-lg"}});const o=document.createElement("FORM");o.autocomplete="off",o.className="space-y-5 mb-5";const t=document.createElement("H3");t.className="text-lg font-medium text-gray-900 dark:text-white",t.textContent="Usuarios Seleccionados",o.appendChild(t);const n=document.createElement("div");n.className="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow";const c=document.createElement("TABLE");c.className="min-w-full table-auto border-collapse";const s=document.createElement("THEAD"),i=document.createElement("TR");["ID","Nombre","Dirección","Zona","Colonia","Meses","Observaciones","Monto","Acciones"].forEach((e=>{const o=document.createElement("TH");o.textContent=e,o.className="px-4 py-2 text-left font-semibold text-sm text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border-b",i.appendChild(o)})),s.appendChild(i),c.appendChild(s);const d=document.createElement("TBODY");e.forEach((e=>{const o=document.createElement("TR");o.className="border-b",Object.values(e).forEach((e=>{const t=document.createElement("TD");t.textContent=e,t.className="px-4 py-2 text-sm text-gray-700 dark:text-gray-200",o.appendChild(t)}));const t=document.createElement("TD");t.className="px-4 py-2 text-center";const n=document.createElement("BUTTON");n.textContent="Eliminar",n.className="text-white bg-red-600 hover:bg-red-800 px-4 py-2 rounded-lg text-sm font-medium focus:outline-none focus:ring-4 focus:ring-red-300",n.onclick=()=>function(e){let o=JSON.parse(localStorage.getItem("usuarios_agregados"))||[];o=o.filter((o=>o.id!==e)),localStorage.setItem("usuarios_agregados",JSON.stringify(o)),a()}(e.id),t.appendChild(n),o.appendChild(t),d.appendChild(o)})),c.appendChild(d),n.appendChild(c),o.appendChild(n);const l=document.createElement("P");l.className="text-sm text-gray-700 dark:text-gray-200",l.textContent=`Total de Registros: ${e.length}`,o.appendChild(l);const m=document.createElement("BUTTON");m.className="text-white bg-orange-500 hover:bg-orange-900 px-5 py-2 rounded text-sm font-medium",m.textContent="Guardar",m.addEventListener("click",r);const u=document.querySelector(".default-modal");u&&u.remove(),Modal.renderModal(o,m),setTimeout((()=>{const e=document.querySelector(".default-modal .max-w-lg");e&&(e.classList.remove("max-w-lg"),e.classList.add("w-auto","max-w-6xl"))}),100)}async function r(){const e=`${location.origin}/notificaciones-registro`;let o=JSON.parse(localStorage.getItem("usuarios_agregados"))||[];try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),n=await t.json();n.success?(Swal.fire({title:"¡Éxito!",text:n.message,icon:"success",confirmButtonText:"Aceptar"}).then((()=>{window.location.href="/notificaciones"})),localStorage.removeItem("usuarios_agregados")):Swal.fire({title:"Error",text:n.message,icon:"error",confirmButtonText:"Aceptar"})}catch(e){console.error("Error al enviar los datos:",e),Swal.fire({title:"Error",text:"Hubo un problema al enviar los datos. Por favor, intenta nuevamente.",icon:"error",confirmButtonText:"Aceptar"})}}document.addEventListener("DOMContentLoaded",(()=>{!function(){const e=document.querySelector("#agregar-deudor");e&&e.addEventListener("click",(()=>a()))}(),e("#dropdownSearchZona ul","/api/zonas","name","zona"),e("#dropdownSearchColonia ul","/api/colonias","name","colonia"),e("#dropdownSearchTipoToma ul","/api/tipotoma","name","tipotoma"),e("#dropdownSearchTipoConsumo ul","/api/tipoconsumo","name","tipoconsumo"),function(){let e=JSON.parse(localStorage.getItem("filtrosSeleccionados"))||{zonas:[],colonias:[],tipoToma:[],tipoConsumo:[]};document.querySelectorAll(".dropdown-confirmar").forEach((n=>{n.addEventListener("click",(function(n){n.preventDefault();const a=this.closest("div[id^='dropdownSearch']");if(a){switch(a.id){case"dropdownSearchZona":e.zonas=o("#dropdownSearchZona");break;case"dropdownSearchColonia":e.colonias=o("#dropdownSearchColonia");break;case"dropdownSearchTipoToma":e.tipoToma=o("#dropdownSearchTipoToma");break;case"dropdownSearchTipoConsumo":e.tipoConsumo=o("#dropdownSearchTipoConsumo")}t(e)}}))})),window.addEventListener("load",(()=>{n("#dropdownSearchZona",e.zonas),n("#dropdownSearchColonia",e.colonias),n("#dropdownSearchTipoToma",e.tipoToma),n("#dropdownSearchTipoConsumo",e.tipoConsumo)}));const a=document.querySelector("#reiniciar");a&&a.addEventListener("click",(()=>{localStorage.removeItem("filtrosSeleccionados"),e={zonas:[],colonias:[],tipoToma:[],tipoConsumo:[]},t(e),document.querySelectorAll('input[type="checkbox"]:checked').forEach((e=>{e.checked=!1})),document.querySelector("form").submit()}))}(),document.querySelectorAll("#agregar-datos").forEach((e=>{e.addEventListener("click",(function(){const e=this.closest("tr"),o=e.querySelectorAll("td"),t={id:o[1].textContent.trim(),nombre:o[2].textContent.trim(),direccion:o[3].textContent.trim(),zona:o[4].textContent.trim(),colonia:o[5].textContent.trim(),meses_rezagados:o[8].textContent.trim(),observaciones:o[9].textContent.trim(),monto:o[10].textContent.trim()};let n=JSON.parse(localStorage.getItem("usuarios_agregados"))||[];n.some((e=>e.id===t.id))||(n.push(t),localStorage.setItem("usuarios_agregados",JSON.stringify(n))),e.remove()}))})),function(e,o=1e4){const t=document.getElementById(e);t&&(t.classList.remove("hidden"),setTimeout((()=>{t.classList.add("hidden")}),o))}("mensajeInfo",5e3)}))})();