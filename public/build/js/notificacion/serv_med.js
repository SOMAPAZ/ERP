import Modal from"../classes/Modal_v1.js";import GetDatos from"../classes/GetData_v1.js";import Formulario from"../classes/Formulario_v1.js";(()=>{const e=document.querySelector("#busqueda"),t=document.querySelector("#listado-coincidencias");let o=[];document.addEventListener("DOMContentLoaded",(()=>{!function(){const e=document.querySelector("#agregar-deudorlec");e&&e.addEventListener("click",(()=>i()))}(),n("#dropdownSearchZona ul","/api/zonas","name","zona"),n("#dropdownSearchColonia ul","/api/colonias","name","colonia"),function(){let e=JSON.parse(localStorage.getItem("filtrosSeleccionadosLec"))||{zonas:[],colonias:[]};document.querySelectorAll(".dropdown-confirmar").forEach((t=>{t.addEventListener("click",(function(t){t.preventDefault();const o=this.closest("div[id^='dropdownSearch']");if(o){switch(o.id){case"dropdownSearchZona":e.zonas=c("#dropdownSearchZona");break;case"dropdownSearchColonia":e.colonias=c("#dropdownSearchColonia")}s(e)}}))})),window.addEventListener("load",(()=>{d("#dropdownSearchZona",e.zonas),d("#dropdownSearchColonia",e.colonias)}));const t=document.querySelector("#reiniciar");t&&t.addEventListener("click",(()=>{localStorage.removeItem("filtrosSeleccionadosLec"),e={zonas:[],colonias:[]},s(e),document.querySelectorAll('input[type="checkbox"]:checked').forEach((e=>{e.checked=!1})),document.querySelector("form").submit()}))}(),document.querySelectorAll("#agregar-datoslec").forEach((e=>{e.addEventListener("click",(function(){const e=this.closest("tr"),t=e.querySelectorAll("td"),o={id:t[0].textContent.trim(),nombre:t[1].textContent.trim(),direccion:t[2].textContent.trim(),zona:t[3].textContent.trim(),colonia:t[4].textContent.trim()};let r=JSON.parse(localStorage.getItem("usuarios_serviciomedido"))||[];r.some((e=>e.id===o.id))||(r.push(o),localStorage.setItem("usuarios_serviciomedido",JSON.stringify(r))),e.remove()}))})),r(),e.addEventListener("input",a),function(e,t=1e4){const o=document.getElementById(e);o&&(o.classList.remove("hidden"),setTimeout((()=>{o.classList.add("hidden")}),t))}("mensajeInfo",5e3)}));const r=async()=>{o=await GetDatos.consultar(`${location.origin}/medids`)};function a(){!function(){for(;t.firstChild;)t.removeChild(t.firstChild)}();const r=e.value.trim();if(""===r)return;if("editar"===document.querySelector("#modoBusqueda").value){let e=[];e=isNaN(r)?o.filter((e=>e.user.toLowerCase().includes(r.toLowerCase()))):o.filter((e=>e.id_user.toString().includes(r))).sort(((e,t)=>parseInt(e.id_user)===parseInt(t.id_user)?parseInt(t.year)===parseInt(e.year)?parseInt(t.mes)-parseInt(e.mes):parseInt(t.year)-parseInt(e.year):parseInt(e.id_user)-parseInt(t.id_user))),document.addEventListener("click",(e=>{const t=document.querySelector("#listado-coincidencias");t&&!t.contains(e.target)&&"busqueda"!==e.target.id&&(t.innerHTML="")}));const a=200;Math.ceil(e.length/a);!function(o){const r=document.createElement("table");r.className="min-w-full divide-y  border border-gray-300 dark:border-gray-600 text-sm text-left dark:text-white text-sm border border-dashed border-gray-300 rounded dark:bg-gray-700 dark:text-gray-300 border border-dashed border-gray-300 rounded";const n=document.createElement("thead");n.className="bg-gray-100 dark:bg-gray-800",n.innerHTML='\n        <tr>\n          <th class="px-4 py-2">ID</th>\n          <th class="px-4 py-2">Usuario</th>\n          <th class="px-4 py-2">Mes</th>\n          <th class="px-4 py-2">Año</th>\n          <th class="px-4 py-2">Lectura</th>\n          <th class="px-4 py-2">Acción</th>\n        </tr>\n      ',r.appendChild(n);const c=document.createElement("tbody");c.className="divide-y divide-gray-100 dark:divide-gray-700";const s=(o-1)*a,d=Math.min(s+a,e.length);for(let t=s;t<d;t++){const o=e[t],r=["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"][o.mes-1],a=document.createElement("tr");a.className="hover:bg-gray-400 dark:hover:bg-gray-600",a.innerHTML=`\n    <td class="px-4 py-2">${o.id_user}</td>\n    <td class="px-4 py-2 uppercase">${o.user}</td>\n    <td class="px-4 py-2">${r}</td>\n    <td class="px-4 py-2">${o.year}</td>\n    <td class="px-4 py-2">${o.lectura}</td>\n    <td class="px-4 py-2"></td>\n  `;const n=document.createElement("button");n.className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600",""===o.mes||""===o.year?(n.textContent="Registrar",n.addEventListener("click",(()=>{window.location.href=`/formularioagendalec?id=${o.id}`}))):(n.textContent="Acceder",n.addEventListener("click",(()=>{u(o)}))),a.children[5].appendChild(n),c.appendChild(a)}r.appendChild(c),t.innerHTML="",t.appendChild(r);const i=t;i.style.overflowY="auto",i.style.maxHeight="400px"}(1)}else!function(){const t=e.value.toLowerCase();document.querySelectorAll("tbody tr").forEach((e=>{const o=e.textContent.toLowerCase();e.style.display=o.includes(t)?"":"none"}))}()}function n(e,t,o="nombre",r="item"){const a=document.querySelector(e);a?fetch(t).then((e=>e.json())).then((e=>{a.innerHTML="",e.forEach(((e,t)=>{const n=document.createElement("li"),c=`${r}-checkbox-${t}`;n.innerHTML=`\n          <div class="flex items-center p-2 rounded-sm hover:bg-gray-100 dark:hover:bg-gray-600">\n              <input id="${c}" type="checkbox" value="${e.id}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500">\n              <label for="${c}" class="w-full ms-2 text-sm font-medium text-gray-900 rounded-sm dark:text-gray-300">${e[o]}</label>\n          </div>\n        `,a.appendChild(n)}))})).catch((e=>{console.error(`Error al consultar ${t}:`,e)})):console.error(`No se encontró el UL en el selector: ${e}`)}function c(e){const t=[];return document.querySelectorAll(`${e} input[type='checkbox']:checked`).forEach((e=>t.push(e.value))),t}function s(e){localStorage.setItem("filtrosSeleccionadosLec",JSON.stringify(e)),document.querySelector("#filtrosInput").value=JSON.stringify(e),document.querySelector("form").submit()}function d(e,t){t.forEach((t=>{const o=document.querySelector(`${e} input[value='${t}']`);o&&(o.checked=!0)}))}function i(){const e=JSON.parse(localStorage.getItem("usuarios_serviciomedido"))||[];if(0===e.length)return void Swal.fire({icon:"info",title:"Atención",html:'<p class="text-base text-gray-700 dark:text-gray-800">No hay usuarios seleccionados.</p>',background:"#ffffff",color:"#1f2937",confirmButtonColor:"#2563eb",confirmButtonText:"Aceptar",customClass:{popup:"dark:bg-gray-800 dark:text-gray-100 rounded-xl shadow-lg",title:"text-blue-600 dark:text-blue-400 font-semibold text-lg"}});const t=document.createElement("FORM");t.autocomplete="off",t.className="space-y-5 mb-5";const o=document.createElement("H3");o.className="text-lg font-medium text-gray-900 dark:text-white",o.textContent="Usuarios Seleccionados",t.appendChild(o);const r=document.createElement("div");r.className="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow";const a=document.createElement("TABLE");a.className="min-w-full table-auto border-collapse";const n=document.createElement("THEAD"),c=document.createElement("TR");["ID","Nombre","Dirección","Zona","Colonia","Acciones"].forEach((e=>{const t=document.createElement("TH");t.textContent=e,t.className="px-4 py-2 text-left font-semibold text-sm text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border-b",c.appendChild(t)})),n.appendChild(c),a.appendChild(n);const s=document.createElement("TBODY");e.forEach((e=>{const t=document.createElement("TR");t.className="border-b",Object.values(e).forEach((e=>{const o=document.createElement("TD");o.textContent=e,o.className="px-4 py-2 text-sm text-gray-700 dark:text-gray-200",t.appendChild(o)}));const o=document.createElement("TD");o.className="px-4 py-2 text-center";const r=document.createElement("BUTTON");r.textContent="Eliminar",r.className="text-white bg-red-600 hover:bg-red-800 px-4 py-2 rounded-lg text-sm font-medium focus:outline-none focus:ring-4 focus:ring-red-300",r.onclick=()=>function(e){let t=JSON.parse(localStorage.getItem("usuarios_serviciomedido"))||[];t=t.filter((t=>t.id!==e)),localStorage.setItem("usuarios_serviciomedido",JSON.stringify(t)),i()}(e.id),o.appendChild(r),t.appendChild(o),s.appendChild(t)})),a.appendChild(s),r.appendChild(a),t.appendChild(r);const d=document.createElement("P");d.className="text-sm text-gray-700 dark:text-gray-200",d.textContent=`Total de usuarios: ${e.length}`,t.appendChild(d);const u=document.createElement("BUTTON");u.className="text-white bg-orange-500 hover:bg-orange-900 px-5 py-2 rounded text-sm font-medium",u.textContent="Guardar",u.addEventListener("click",l);const m=document.querySelector(".default-modal");m&&m.remove(),Modal.renderModal(t,u),setTimeout((()=>{const e=document.querySelector(".default-modal .max-w-lg");e&&(e.classList.remove("max-w-lg"),e.classList.add("w-auto","max-w-6xl"))}),100)}async function l(){const e=`${location.origin}/notificaciones-registrolec`;let t=JSON.parse(localStorage.getItem("usuarios_serviciomedido"))||[];try{const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),r=await o.json();r.success?(Swal.fire({title:"¡Éxito!",text:r.message,icon:"success",confirmButtonText:"Aceptar"}).then((()=>{window.location.href="/lecturas"})),localStorage.removeItem("usuarios_serviciomedido")):Swal.fire({title:"Error",text:r.message,icon:"error",confirmButtonText:"Aceptar"})}catch(e){console.error("Error al enviar los datos:",e),Swal.fire({title:"Error",text:"Hubo un problema al enviar los datos. Por favor, intenta nuevamente.",icon:"error",confirmButtonText:"Aceptar"})}}function u(e){const t=document.createElement("FORM");t.autocomplete="off",t.className="space-y-5 mb-5 uppercase";const o=document.createElement("H3");o.className="text-lg font-medium text-gray-900 dark:text-white",o.textContent="Editar Lecturas de "+e.id_user,t.appendChild(o);const r=["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"][e.mes-1];Formulario.crearInput2(t,"Id de usuario","text","id_user",e.id_user,!0),Formulario.crearInput2(t,"Nombre del Usuario","text","user",e.user,!0),Formulario.crearInput2(t,"Año","text","year",e.year,!0),Formulario.crearInput2(t,"Mes","text","mes",r,!0),Formulario.crearInput2(t,"Lectura","text","lectura",e.lectura);const a=document.createElement("BUTTON");a.className="text-white bg-orange-500 hover:bg-orange-900 px-5 py-2 rounded text-sm font-medium",a.textContent="Guardar",a.addEventListener("click",(()=>{const t=document.querySelector("input[name='year']").value,o=document.querySelector("input[name='mes']").value,r=document.querySelector("input[name='lectura']").value;console.log("Datos a enviar:",{id_user:e.id_user,year:t,mes:o,lectura:r}),async function(e,t,o,r){const a=await fetch("/actualizar-lectura",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_user:e,year:t,mes:o,lectura:r})}),n=await a.json();n.success?Swal.fire({title:"¡Éxito!",text:n.message,icon:"success",confirmButtonText:"Aceptar"}).then((()=>{window.location.href="/lecturas"})):Swal.fire({title:"Error",text:n.message,icon:"error",confirmButtonText:"Aceptar"})}(e.id_user,t,o,r)})),Modal.renderModal(t,a)}document.getElementById("modoBusqueda").addEventListener("change",(function(){const e="editar"===this.value?"Buscar por ID o Nombre de usuario para editar lectura":"Buscar por ID o Nombre de usuario para generar agenda";document.getElementById("busqueda").setAttribute("placeholder",e)}))})();