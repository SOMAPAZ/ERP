(()=>{const e=document.getElementById("formulario-notificaciones"),t=document.getElementById("idUser"),n=document.getElementById("evidencia"),o=document.getElementById("lectura"),r=document.getElementById("select-año"),a=document.getElementById("select-mes"),l=document.getElementById("evidencia");async function c(e){e.preventDefault();const c=t.value.trim(),i=n.value.trim(),u=o.value.trim(),m=l.files[0],g=r.value,p=a.value,f=localStorage.getItem("lectura"),v=f?JSON.parse(f).id:null;if(!g)return void d("Debe seleccionar un Año.");if(!p)return void d("Debe seleccionar un Mes.");if(!u)return void d("Debe ingresar una Lectura.");const E={idUser:c,evidencia:i,lectura:u,id:v,"año":g,mes:p},b=new FormData;b.append("id_user",c),b.append("evidencia",i),b.append("lectura",u),b.append("year",g),b.append("mes",p),m&&b.append("imagen",m),v?b.append("id",v):b.append("id",s);try{const e=`${location.origin}/api/notificaciones/agenda-lec`,t=await fetch(e,{method:"POST",body:b}),n=await t.json();"Error"===n.tipo?Swal.fire({title:"Atención",text:n.mensaje,icon:"info",confirmButtonText:"OK"}):"Exito"===n.tipo&&(localStorage.setItem("lectura",JSON.stringify(E)),Swal.fire({title:n.tipo,text:n.mensaje,icon:"success",confirmButtonText:"OK"}).then((()=>{window.location.href="/agendalec",localStorage.removeItem("lectura")})))}catch(e){console.log(e),Swal.fire({title:"Error",text:"Ocurrió un error al enviar el formulario.",icon:"error",confirmButtonText:"OK"})}}function d(t){const n=document.createElement("DIV");n.className="rounded border-s-4 mt-6 border-red-500 bg-red-50 p-4 dark:border-red-600 dark:bg-red-900 alerta",n.innerHTML=`<strong class="block font-medium text-red-700 dark:text-red-200">${t}</strong>`,document.querySelector(".alerta")?.remove(),e.parentElement.insertBefore(n,e),setTimeout((()=>{n.remove()}),5e3)}function i(){let e=document.getElementById("lectura"),t=e.value;t=t.replace(/[^\d.]/g,"");const n=t.split(".");n.length>2&&(t=n[0]+"."+n.slice(1).join(""));const o=t.split(".");o.length>1&&(o[1]=o[1].slice(0,2),t=o[0]+"."+o[1]),e.value=t;let r=document.getElementById("medidor");r.innerHTML="";let[a,l]=t.split(".");for(let e=0;e<a.length;e++){let t=document.createElement("label");t.classList.add("dial","bg-white","dark:bg-gray-600","text-black","dark:text-black","text-3xl","font-bold","w-16","h-16","flex","items-center","justify-center","rounded-lg","shadow-md","border","border-gray-400","dark:border-gray-500"),t.textContent=a[e],r.appendChild(t)}if(l){let e=document.createElement("label");e.classList.add("text-3xl","flex","items-center","justify-center","dark:text-white","font-extrabold"),e.textContent=".",r.appendChild(e);for(let e=0;e<l.length;e++){let t=document.createElement("label");t.classList.add("dial","bg-white","dark:bg-gray-600","text-black","dark:text-black","text-3xl","font-bold","w-16","h-16","flex","items-center","justify-center","rounded-lg","shadow-md","border","border-gray-400","dark:border-gray-500"),t.textContent=l[e],r.appendChild(t)}}if(!l){let e=document.createElement("label");e.classList.add("text-3xl","flex","items-center","justify-center","dark:text-white","font-extrabold"),e.textContent=".",r.appendChild(e)}}document.addEventListener("DOMContentLoaded",(()=>{!function(){const e=localStorage.getItem("lectura");if(console.log("Datos en localStorage:",e),e){const t=JSON.parse(e);document.getElementById("idUser").value=t.id_user,document.getElementById("nombreCompleto").value=t.user,document.getElementById("direccion").value=t.address,document.getElementById("colonia").value=t.id_colony,document.getElementById("zona").value=t.id_zone,document.getElementById("observaciones").value=t.id_observaciones}}(),function(){const e=(new Date).getFullYear(),t=(new Date).getMonth()+1,n=2023,o=document.getElementById("select-año");for(let t=e;t>=n;t--){const e=document.createElement("option");e.value=t,e.textContent=t,o.appendChild(e)}const r=document.getElementById("select-mes"),a=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];r.innerHTML="";const l=document.createElement("option");l.value="",l.textContent="Seleccione un mes",l.disabled=!0,l.selected=!0,r.appendChild(l),o.addEventListener("change",(()=>{const n=parseInt(o.value),l=localStorage.getItem("lectura");if(l){JSON.parse(l);!function(e){const t=localStorage.getItem("lectura");if(!t)return void console.error("No se encontraron datos en localStorage");const n=JSON.parse(t),o=n.id_user;console.log("ID del Usuario:",o),console.log("Año:",e),fetch("/meses-lecturas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idUser:o,"año":e})}).then((e=>{if(!e.ok)throw new Error("Error en la solicitud");return e.json()})).then((e=>{"success"===e.status?function(e){const t=document.getElementById("select-mes");if(!t)return void console.error("El select de meses no se encontró en el DOM.");const n=t.getElementsByTagName("option");if(!e||0===e.length)return void console.error("No se encontraron meses con lectura.");for(let t=0;t<n.length;t++){const o=n[t].value,r=e.find((e=>e.mes===o));console.log(`Mes: ${o}, Lectura: ${r?r.lectura:"No hay lectura"}`),r&&r.lectura&&(n[t].textContent+="",n[t].className="text-green-500 dark:text-white bg-green-200 dark:bg-green-600 cursor-pointer")}}(e.data):console.error("Error en la respuesta:",e.message)})).catch((e=>{console.error("Hubo un error:",e)}))}(n)}if(r.innerHTML="",n===e){for(let e=0;e<t;e++){const t=document.createElement("option");t.value=e+1,t.textContent=a[e],r.appendChild(t)}const e=document.createElement("option");e.value=t+1,e.textContent=a[t],r.appendChild(e)}else a.forEach(((e,t)=>{const n=document.createElement("option");n.value=t+1,n.textContent=e,r.appendChild(n)}))}));if(parseInt(o.value)===e){for(let e=0;e<t;e++){const t=document.createElement("option");t.value=e+1,t.textContent=a[e],r.appendChild(t)}const e=document.createElement("option");e.value=t+1,e.textContent=a[t],r.appendChild(e)}else a.forEach(((e,t)=>{const n=document.createElement("option");n.value=t+1,n.textContent=e,r.appendChild(n)}))}(),e.addEventListener("submit",c),o.addEventListener("input",i)}));new URLSearchParams(window.location.search).get("id");document.addEventListener("DOMContentLoaded",(()=>{const e=new URLSearchParams(window.location.search).get("id");console.log(e),e?async function(e){try{const t=await fetch(`${location.origin}/medids?id=${e}`);if(!t.ok)return void console.error("Error en la respuesta del servidor:",t.statusText);const n=(await t.json()).find((t=>t.id===e));n?(console.log("Usuario parseado:",n),console.log("ID enviado:",e),s=n.id,document.getElementById("idUser").value=n.id_user,document.getElementById("nombreCompleto").value=n.user,document.getElementById("direccion").value=n.address,document.getElementById("colonia").value=n.colonia,document.getElementById("zona").value=n.zona,document.getElementById("observaciones").value=n.id_observaciones):console.error("Usuario no encontrado")}catch(e){console.error("Error al cargar los datos del usuario:",e)}}(e):console.error("ID de usuario no encontrado en la URL")}));let s=null})();