import Alerta from"../classes/Alerta_v1.js";import GetDatos from"../classes/GetData_v1.js";import PostDatos from"../classes/PostData_v1.js";import{formatDateText,limpiarHTML}from"../helpers/index_v1.js";(()=>{const e=document.querySelector("#nombre"),t=document.querySelector("#idUser"),o=document.querySelector("#direccion"),n=document.querySelector("#telefono"),a=document.querySelector("#beneficiario"),r=document.querySelector("#categoria"),i=document.querySelector("#incidencia"),s=document.querySelector("#prioridad"),c=document.querySelector("#resetear-formulario"),d=document.querySelector("#coincidencias-usuario"),l=document.querySelector("#coincidencias-ID"),p=document.querySelector("#formulario-reporte"),u=document.querySelector("#reporte-reciente");let m=[],g=[],f=[];document.addEventListener("DOMContentLoaded",(()=>{x(),e.addEventListener("input",v),t.addEventListener("input",h),r.addEventListener("change",b),c.addEventListener("click",(()=>p.reset())),p.addEventListener("submit",y);const o=new URLSearchParams(window.location.search),n=o.get("id_user"),a=o.get("idx");n&&a&&async function(e,t){try{const n=await fetch(`${location.origin}/api/usuarios?id=${e}`);if(!n.ok)return void console.error("Error en la respuesta del servidor:",n.statusText);const a=(await n.json()).find((t=>String(t.id)===e)),r=await fetch(`${location.origin}/deuda-desglosada?id=${e}`);if(!r.ok)return void console.error("Error al obtener deuda del usuario");const i=await fetch(`${location.origin}/deuda-usuario?id=${e}`);if(!i.ok)return void console.error("Error al obtener deuda del usuario");const s=await r.json(),{periodo:c}=await i.json(),d=c?.inicio_rez&&c?.final_rez?`${o(c.inicio_rez)} a ${o(c.final_rez)}`:"s/d",l=e=>{const t=new Date(e);return t.setHours(0,0,0,0),t},p=l(c.inicio_rez),u=l(c.final_rez);u.setDate(u.getDate()+1),console.log(p,u);const m=s.filter((({fecha:e})=>{const t=new Date(e);return t>=p&&t<=u}));m.forEach((({fecha:e,total:t})=>{console.log(`Mes: ${e} - Monto: $${(t?.general||0).toFixed(2)}`)}));const g=m.reduce(((e,t)=>e+(t.total?.general||0)),0);function o(e){const t=["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"],[o,n,a]=e.split("-");return`${t[parseInt(n,10)-1]} ${o}`}if(console.log("Total periodo válido:",g.toFixed(2)),a){const f=`NOT/${t}`;document.getElementById("idUser").value=a.id,document.getElementById("nombre").value=a.nombre,document.getElementById("direccion").value=a.direccion,document.getElementById("telefono").value="0"===a.telefono?"s/n":a.telefono,document.getElementById("beneficiario").value="s/n",document.getElementById("descripcion").value=`Se realiza reporte de suspensión de agua y/o drenaje debido a que el usuario tiene una notificación con folio ${f} vencida. Monto: ${g.toLocaleString("es-MX",{style:"currency",currency:"MXN"})}. Periodo: ${d}`}else console.error("Usuario no encontrado")}catch(x){console.error("Error al cargar los datos del usuario:",x)}}(n,a);const i=o.get("id_users"),s=o.get("idxs");i&&s&&reporteConvenio(i,s)}));const x=async()=>{[m,g,f]=await Promise.all([GetDatos.consultar(`${location.origin}/api/users`),GetDatos.consultar(`${location.origin}/api/prioridades`),GetDatos.consultar(`${location.origin}/api/categorias`)]),k(s,g),k(r,f)},y=async e=>{e.preventDefault();const t=await PostDatos.guardarDatos(`${location.origin}/api/reporte`,p.querySelectorAll(".input-report"));"Exito"===t.tipo&&(p.reset(),Swal.fire({icon:"success",title:"Proceso exitoso",text:t.mensaje}),E(t.reporte))},v=()=>{const t=e.value.trim().toLowerCase();if(""===t||t.length<3)return;limpiarHTML(d),[...m].filter((e=>e.nombre.toLowerCase().includes(t.toLowerCase()))).forEach((e=>{const t=document.createElement("LI");t.className="block rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 dark:bg-gray-800 dark:text-gray-200 uppercase cursor-pointer",t.onclick=()=>w(e,d),t.textContent=e.nombre,d.appendChild(t)}))},h=()=>{const e=t.value.trim();if(""===e||0==e)return;limpiarHTML(l),[...m].filter((t=>t.id.includes(e))).forEach((e=>{const t=document.createElement("LI");t.className="block rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 dark:bg-gray-800 dark:text-gray-200 uppercase cursor-pointer",t.onclick=()=>w(e,l),t.textContent=`${e.id} - ${e.nombre}`,l.appendChild(t)}))},b=async e=>{const t=e.target.value;if(""===t)return i.setAttribute("disabled","disabled"),void limpiarHTML(i);i.removeAttribute("disabled");const o=await PostDatos.enviarArray(`${location.origin}/api/incidencias`,t);"error"!==o.tipo?o.datos.forEach((e=>{const t=document.createElement("OPTION");t.value=e.id,t.textContent=e.name,i.appendChild(t)})):i.setAttribute("disabled","disabled")},E=e=>{limpiarHTML(u);const t=document.createElement("DIV");t.className="grid grid-cols-2 gap-4";const o=document.createElement("A");o.className="text-xl font-extrabold text-gray-900 dark:text-white uppercase hover:underline",o.href=`/reporte?folio=${e.id}`,o.innerHTML=`Folio: <span class="font-semibold ms-2">${e.id}</span>`;const n=g.filter((t=>t.name===e.id_priority)).shift(),a=document.createElement("DIV"),r=document.createElement("SPAN");r.className=`inline-block rounded bg-${n.color}-100 px-2.5 py-0.5 text-xs font-extrabold text-${n.color}-800 dark:bg-${n.color}-900 dark:text-${n.color}-300 md:mb-0 uppercase`,r.textContent=n.name,a.appendChild(r),t.appendChild(o),t.appendChild(a);const i=document.createElement("DIV");i.className="grid md:grid-cols-2 gap-2 md:gap-6 col-span-2 text-base text-gray-900 dark:text-white";const s=document.createElement("DIV");s.classList.add("space-y-2"),s.innerHTML=`\n      <div class="flex flex-col md:flex-row md:gap-2 uppercase">\n        <p class="block font-bold py-1">\n            Usuario: <span class="font-normal text-gray-500 dark:text-gray-400">${e.name}</span>\n        </p>\n      </div>\n      <div class="flex flex-col md:flex-row md:gap-2">\n        <p class="block font-bold py-1">\n            Dirección: <span class="font-normal text-gray-500 dark:text-gray-400">${e.address}</span>\n        </p>\n      </div>\n      <div class="flex flex-col md:flex-row md:gap-2">\n        <p class="block font-bold py-1"> Fecha emisión: \n          <span class="font-normal text-gray-500 dark:text-gray-400">${e.created}</span>\n        </p>\n      </div>\n    `;const c=document.createElement("DIV");c.classList.add("space-y-2"),c.innerHTML=`\n      <div class="flex flex-col md:flex-row md:gap-2 uppercase">\n          <p class="block font-bold py-1">\n              Categoría:\n              <span class="font-normal text-gray-500 dark:text-gray-400">\n                  ${e.id_category}\n              </span>\n          </p>\n      </div>\n      <div class="flex flex-col md:flex-row md:gap-2">\n          <p class="block font-bold py-1">\n              Incidencia:\n              <span class="font-normal text-gray-500 dark:text-gray-400">\n                ${e.id_incidence}\n              </span>\n          </p>\n      </div>\n    `;const d=document.createElement("DIV");d.className="flex justify-center md:justify-end gap-1 col-span-2 md:col-span-1";const l=document.createElement("DIV"),p=document.createElement("A");p.className="flex items-center justify-center w-full uppercase bg-blue-600 text-font-light text-xs py-2 px-6 rounded-md shadow-md hover:bg-blue-500 gap-2",p.href=`/reporte?folio=${e.id}`,p.innerHTML='\n        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>\n        <p class="font-bold text-xs">Acceder</p>\n      ';const m=document.createElement("DIV"),f=document.createElement("BUTTON");f.className="flex items-center justify-center w-full uppercase bg-cyan-600 text-font-light text-xs py-2 px-6 rounded-md shadow-md hover:bg-cyan-500 gap-2",f.innerHTML='\n        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.057 1.123-.08M15.75 18H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08M15.75 18.75v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 6.375 7.5H5.25m11.9-3.664A2.251 2.251 0 0 0 15 2.25h-1.5a2.251 2.251 0 0 0-2.15 1.586m5.8 0c.065.21.1.433.1.664v.75h-6V4.5c0-.231.035-.454.1-.664M6.75 7.5H4.875c-.621 0-1.125.504-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V16.5a9 9 0 0 0-9-9Z" /></svg>\n        <p class="font-bold text-xs">Copiar</p>\n      ',f.onclick=()=>$(e),l.appendChild(p),m.appendChild(f),d.appendChild(l),d.appendChild(m),c.appendChild(d),i.appendChild(s),i.appendChild(c),u.appendChild(t),u.appendChild(i)},$=e=>{const t=`*Folio:* ${e.id}\n*ID Usuario:* ${e.id_user}\n*Nombre:* ${e.name}\n*Teléfono:* ${e.phone}\n*Direccion:* ${e.address}\n*Emision:* ${formatDateText(e.created)}\n*Categoria:* ${e.id_category}\n*Incidencia:* ${e.id_incidence}\n*Prioridad:* ${e.id_priority}\n*Descripción:* ${e.description}`;navigator.clipboard.writeText(t)&&Alerta.Toast.fire({title:"Exito",text:"Texto copiado al portapapeles",icon:"success"})},w=async(r,i)=>{const s=await GetDatos.consultar(`${location.origin}/api/usuario?id=${r.id}`);e.value=`${s.user} ${s.lastname}`,t.value=s.id,o.value=s.address,n.value="0"===s.phone?"s/#":s.phone,a.value="s/n",limpiarHTML(i)},k=(e,t)=>{t.forEach((t=>{const o=document.createElement("OPTION");o.value=t.id,o.textContent=t.name,e.appendChild(o)}))}})();